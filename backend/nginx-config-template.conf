# ================================
# AI菜单系统 - Nginx配置模板
# ================================
# 部署位置: /etc/nginx/sites-available/ai-menu-api
# 使用方法:
#   1. 复制到服务器: scp nginx-config-template.conf root@your_ecs_ip:/etc/nginx/sites-available/ai-menu-api
#   2. 修改域名: vim /etc/nginx/sites-available/ai-menu-api
#   3. 创建软链接: ln -s /etc/nginx/sites-available/ai-menu-api /etc/nginx/sites-enabled/
#   4. 测试配置: nginx -t
#   5. 重启Nginx: systemctl restart nginx

# ================================
# HTTP配置（备案前或使用IP访问）
# ================================
server {
    listen 80;
    listen [::]:80;
    
    # 如果使用域名，取消下面注释并替换为实际域名
    # server_name api.ai-menu.tech;
    
    # 如果使用IP访问，注释掉上面的server_name
    
    # 访问日志
    access_log /var/log/nginx/ai-menu-api.access.log;
    error_log /var/log/nginx/ai-menu-api.error.log;
    
    # 客户端上传文件大小限制（根据Excel文件大小调整）
    client_max_body_size 50M;
    
    # API代理
    location / {
        # 代理到后端服务
        proxy_pass http://localhost:8080;
        
        # HTTP版本
        proxy_http_version 1.1;
        
        # WebSocket支持
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # 传递真实客户端信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 禁用缓存
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 健康检查（不记录日志）
    location /health {
        proxy_pass http://localhost:8080/health;
        access_log off;
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ================================
# HTTPS配置（域名备案后，由certbot自动添加）
# ================================
# certbot会在这里自动添加HTTPS配置
# 命令: certbot --nginx -d api.ai-menu.tech

# ================================
# 性能优化配置（可选）
# ================================

# Gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript 
           application/json application/javascript application/xml+rss 
           application/rss+xml font/truetype font/opentype 
           application/vnd.ms-fontobject image/svg+xml;

# 缓存设置（根据需要调整）
# location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
#     expires 7d;
#     add_header Cache-Control "public, no-transform";
# }

