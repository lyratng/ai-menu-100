# 第三方服务配置指南

> 本文档说明项目需要开通的第三方服务账户、配置步骤和所需信息。

---

## 📋 服务清单总览

| 服务 | 提供商 | 用途 | 是否必需 | 预计成本 |
|------|--------|------|----------|----------|
| 数据库 | 阿里云RDS | PostgreSQL数据库 | ✅ 必需 | ¥200-500/月 |
| 对象存储 | 阿里云OSS | Excel文件存储 | ✅ 必需 | ¥10-50/月 |
| 云服务器 | 阿里云ECS | 部署后端API | ✅ 必需 | ¥200-500/月 |
| AI服务 | DeepSeek | 菜单生成和解析 | ✅ 必需 | 按量计费 |
| 前端部署 | Vercel | 前端托管 | ✅ 必需 | 免费 |
| AI服务 | OpenAI | GPT-5（预留） | ⏸️ 预留 | 按量计费 |
| 日志服务 | 阿里云SLS | 日志收集 | ⏸️ 可选 | ¥50-100/月 |

---

## 1️⃣ DeepSeek API（必需）

### 用途
- 菜单生成（AI根据约束条件生成菜单）
- 历史菜单解析（AI提取菜品标签）
- Embedding服务（预留，用于RAG检索）

### 申请步骤
1. 访问：https://platform.deepseek.com/
2. 注册账号
3. 充值（建议先充¥100测试）
4. 创建API Key

### 需要记录的信息
```bash
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
EMBEDDING_MODEL=deepseek-embedder
LLM_MODEL=deepseek-chat
```

### 费用预估
- deepseek-chat：¥1/百万tokens输入，¥2/百万tokens输出
- 预计每次生成菜单消耗：5000-10000 tokens
- 预计每月费用：¥50-200（取决于使用频率）

---

## 2️⃣ 阿里云账号（必需）

### 2.1 创建阿里云账号
1. 访问：https://www.aliyun.com/
2. 注册账号（需要实名认证）
3. 完成企业认证（可选，享受企业优惠）

### 2.2 配置AccessKey
1. 登录阿里云控制台
2. 右上角头像 → AccessKey管理
3. 创建AccessKey（会生成AccessKeyId和AccessKeySecret）
4. **重要**：立即复制保存，后续无法再查看Secret

### 需要记录的信息
```bash
OSS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxxxx
OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

---

## 3️⃣ 阿里云RDS PostgreSQL（必需）

### 用途
- 存储所有业务数据（菜品、菜单、用户等）
- 使用pgvector扩展支持向量检索

### 购买步骤
1. 登录阿里云控制台
2. 产品与服务 → 数据库 → 云数据库 RDS
3. 点击"创建实例"

### 配置建议
| 配置项 | 推荐值 | 说明 |
|--------|--------|------|
| 地域 | 华北2（北京） | 与ECS同区域，降低延迟 |
| 数据库类型 | PostgreSQL | - |
| 版本 | 14或以上 | 支持pgvector |
| 系列 | 基础版 | 开发测试用，生产可选高可用版 |
| 规格 | 2核4GB | 初期足够，可按需升级 |
| 存储 | 50GB | 按需调整 |
| 网络类型 | 专有网络VPC | 安全性更好 |

### 购买后配置
1. **设置白名单**
   - 添加ECS内网IP
   - 添加你的开发机公网IP（用于本地调试）

2. **创建数据库账号**
   - 账号名：ai_menu_admin
   - 密码：设置强密码（至少16位）
   - 权限：读写权限

3. **创建数据库**
   - 数据库名：ai_menu
   - 字符集：UTF8

4. **启用pgvector扩展**
   ```sql
   CREATE EXTENSION IF NOT EXISTS vector;
   ```

5. **开启自动备份**
   - 备份周期：每天
   - 备份保留：90天

### 需要记录的信息
```bash
DATABASE_URL=postgres://ai_menu_admin:YOUR_PASSWORD@rm-xxxxx.pg.rds.aliyuncs.com:5432/ai_menu
```

### 费用预估
- 基础版 2核4GB：约¥200-300/月
- 高可用版 2核4GB：约¥500-800/月

---

## 4️⃣ 阿里云OSS（必需）

### 用途
- 存储用户上传的Excel历史菜单
- 存储生成的菜单Excel下载文件

### 购买步骤
1. 登录阿里云控制台
2. 产品与服务 → 存储 → 对象存储OSS
3. 创建Bucket

### Bucket配置
| 配置项 | 推荐值 | 说明 |
|--------|--------|------|
| Bucket名称 | ai-menu-prod | 全局唯一 |
| 地域 | 华北2（北京） | 与RDS、ECS同区域 |
| 存储类型 | 标准存储 | - |
| 读写权限 | 私有 | 通过后端API控制访问 |
| 服务端加密 | 启用 | 可选，增强安全性 |

### 配置CORS（允许前端上传）
```json
[
  {
    "allowedOrigins": [
      "https://app.ai-menu.tech",
      "https://admin.ai-menu.tech",
      "http://localhost:3000",
      "http://localhost:3001"
    ],
    "allowedMethods": [
      "GET",
      "POST",
      "PUT",
      "DELETE"
    ],
    "allowedHeaders": ["*"],
    "exposeHeaders": [],
    "maxAgeSeconds": 3600
  }
]
```

### 需要记录的信息
```bash
OSS_REGION=oss-cn-beijing
OSS_BUCKET=ai-menu-prod
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com
# AccessKey已在阿里云账号部分获取
```

### 费用预估
- 存储费用：¥0.12/GB/月
- 流量费用：¥0.5/GB（下行流量）
- 预计每月：¥10-50（根据用户数量）

---

## 5️⃣ 阿里云ECS（必需）

### 用途
- 部署后端API服务（Fastify）
- 运行Docker容器（Redis、Nginx）

### 购买步骤
1. 登录阿里云控制台
2. 产品与服务 → 计算 → 云服务器ECS
3. 创建实例

### 配置建议
| 配置项 | 推荐值 | 说明 |
|--------|--------|------|
| 地域 | 华北2（北京） | 与RDS、OSS同区域 |
| 实例规格 | 2核4GB | 初期足够 |
| 镜像 | Ubuntu 22.04 | 稳定版 |
| 系统盘 | 40GB SSD | - |
| 网络 | 专有网络VPC | 与RDS同VPC |
| 公网带宽 | 5Mbps | 按量付费 |
| 安全组 | 放行22、80、443、8080端口 | - |

### 购买后配置
1. **登录服务器**
   ```bash
   ssh root@your_ecs_ip
   ```

2. **安装Docker**
   ```bash
   curl -fsSL https://get.docker.com | bash
   sudo systemctl start docker
   sudo systemctl enable docker
   ```

3. **安装docker-compose**
   ```bash
   sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   ```

4. **配置防火墙**
   ```bash
   sudo ufw allow 22    # SSH
   sudo ufw allow 80    # HTTP
   sudo ufw allow 443   # HTTPS
   sudo ufw allow 8080  # API（可选，通过Nginx反代后可关闭）
   sudo ufw enable
   ```

### 需要记录的信息
```bash
ECS_IP=xxx.xxx.xxx.xxx
ECS_USER=root
```

### 费用预估
- 2核4GB：约¥200-300/月
- 4核8GB：约¥400-600/月

---

## 6️⃣ Vercel（必需）

### 用途
- 部署用户前端（app.ai-menu.tech）
- 部署管理后台（admin.ai-menu.tech）

### 申请步骤
1. 访问：https://vercel.com/
2. 使用GitHub账号登录
3. 授权访问你的GitHub仓库

### 项目配置

#### 用户前端项目
1. New Project → Import Repository
2. 选择你的仓库
3. 配置构建设置：
   ```
   Framework Preset: Next.js
   Root Directory: frontend
   Build Command: pnpm build
   Output Directory: .next
   Install Command: pnpm install
   ```
4. 环境变量：
   ```
   NEXT_PUBLIC_API_URL=https://api.ai-menu.tech
   ```
5. 域名配置：
   - Settings → Domains
   - 添加：app.ai-menu.tech
   - 配置DNS：添加CNAME记录指向Vercel

#### 管理后台项目
1. 创建另一个项目
2. 同样配置，但Root Directory改为`admin`
3. 域名：admin.ai-menu.tech

### 费用
- Hobby Plan：免费
- Pro Plan：$20/月（可选，提供更多配额）

---

## 7️⃣ 域名DNS配置（必需）

### 域名：ai-menu.tech

假设你已拥有此域名，需要配置以下DNS记录：

| 类型 | 主机记录 | 记录值 | 说明 |
|------|----------|--------|------|
| CNAME | app | cname.vercel-dns.com | 用户前端 |
| CNAME | admin | cname.vercel-dns.com | 管理后台 |
| A | api | ECS公网IP | 后端API |

### 配置步骤
1. 登录域名管理后台（阿里云、腾讯云等）
2. DNS解析设置
3. 添加上述记录
4. 等待生效（通常5-10分钟）

---

## 8️⃣ SSL证书（必需）

### api.ai-menu.tech的证书

**方案1：Let's Encrypt免费证书（推荐）**
```bash
# 在ECS上安装certbot
sudo apt install certbot
sudo certbot certonly --standalone -d api.ai-menu.tech
```

**方案2：阿里云SSL证书**
1. 登录阿里云控制台
2. SSL证书 → 购买免费证书
3. 申请证书：api.ai-menu.tech
4. 验证域名所有权
5. 下载证书（选择Nginx格式）
6. 上传到ECS

### app和admin的证书
Vercel自动提供免费SSL证书，无需手动配置。

---

## 9️⃣ OpenAI API（预留，暂不需要）

### 用途
- GPT-5菜单生成（预留接口）

### 申请步骤
1. 访问：https://platform.openai.com/
2. 注册账号
3. 绑定信用卡
4. 创建API Key

### 需要记录的信息
```bash
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.openai.com/v1
```

### 代理问题
OpenAI API在国内无法直接访问，需要：
- 方案1：使用代理服务（如OpenAI代理服务）
- 方案2：在ECS上配置代理
- 方案3：使用第三方转发服务

**当前策略**：先不配置，主要使用DeepSeek。

---

## 🔟 阿里云SLS日志服务（可选）

### 用途
- 收集后端API日志
- 收集Nginx访问日志
- 日志查询与分析

### 购买步骤
1. 登录阿里云控制台
2. 产品与服务 → 日志服务SLS
3. 创建Project和Logstore

### 费用
- 免费额度：500MB/天
- 超出后：¥0.09/GB
- 预计每月：¥50-100

### 配置
```bash
ALIYUN_SLS_PROJECT=ai-menu-logs
ALIYUN_SLS_LOGSTORE=app
ALIYUN_SLS_ENDPOINT=cn-beijing.log.aliyuncs.com
```

---

## ✅ 配置检查清单

### 必需服务（开发阶段）
- [ ] DeepSeek API Key已获取
- [ ] 阿里云账号已创建
- [ ] 阿里云AccessKey已创建
- [ ] RDS PostgreSQL已购买并配置
- [ ] OSS Bucket已创建
- [ ] ECS服务器已购买并安装Docker
- [ ] Vercel账号已创建
- [ ] 域名DNS已配置
- [ ] SSL证书已申请

### 可选服务（生产阶段）
- [ ] OpenAI API Key（预留）
- [ ] 阿里云SLS日志服务

---

## 📝 环境变量汇总

### 后端 (.env)
```bash
# 数据库
DATABASE_URL=postgres://ai_menu_admin:PASSWORD@rm-xxxxx.pg.rds.aliyuncs.com:5432/ai_menu

# Redis
REDIS_URL=redis://redis:6379

# 阿里云OSS
OSS_REGION=oss-cn-beijing
OSS_BUCKET=ai-menu-prod
OSS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxxxx
OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com

# DeepSeek AI
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
EMBEDDING_MODEL=deepseek-embedder
LLM_MODEL=deepseek-chat

# OpenAI（预留）
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.openai.com/v1

# JWT
JWT_SECRET=your_jwt_secret_min_32_chars_random_string
JWT_EXPIRES_IN=7d

# 服务器
PORT=8080
NODE_ENV=production

# 队列
QUEUE_REDIS_URL=redis://redis:6379

# 日志（可选）
ALIYUN_SLS_PROJECT=ai-menu-logs
ALIYUN_SLS_LOGSTORE=app
ALIYUN_SLS_ENDPOINT=cn-beijing.log.aliyuncs.com
```

### 前端 (.env.local)
```bash
# 用户前端
NEXT_PUBLIC_API_URL=https://api.ai-menu.tech

# 管理后台
NEXT_PUBLIC_API_URL=https://api.ai-menu.tech
```

---

## 💰 总费用预估

### 开发测试阶段（月费用）
- DeepSeek API：¥50
- RDS PostgreSQL（基础版）：¥200
- OSS：¥10
- ECS（2核4GB）：¥200
- Vercel：免费
- **总计：约¥460/月**

### 生产阶段（月费用）
- DeepSeek API：¥100-200
- RDS PostgreSQL（高可用版）：¥500-800
- OSS：¥20-50
- ECS（4核8GB）：¥400-600
- SLS日志：¥50-100
- Vercel Pro：$20（¥140）
- **总计：约¥1210-1930/月**

---

## 📞 联系方式

如有配置问题，请联系：lyratng@163.com

