# 🚀 AI菜单系统 - 生产环境部署指南

> **部署目标**：将系统部署到 `ai-menu.tech` 域名，保证国内用户不翻墙可正常访问

---

## 📋 目录

- [一、部署架构总览](#一部署架构总览)
- [二、甲方需要准备的资源清单](#二甲方需要准备的资源清单)
- [三、部署前准备工作](#三部署前准备工作)
- [四、前端部署（Vercel）](#四前端部署vercel)
- [五、后端部署（阿里云ECS）](#五后端部署阿里云ecs)
- [六、数据库和服务配置](#六数据库和服务配置)
- [七、域名DNS配置](#七域名dns配置)
- [八、部署验证](#八部署验证)
- [九、常见问题](#九常见问题)

---

## 一、部署架构总览

```
┌─────────────────────────────────────────────────┐
│ 用户前端: https://app.ai-menu.tech              │
│ 管理后台: https://admin.ai-menu.tech            │
│ → Vercel部署 (免费)                              │
│ → 不需要域名备案                                 │
└─────────────────────────────────────────────────┘
                      ↓ HTTPS API请求
┌─────────────────────────────────────────────────┐
│ 后端API: https://api.ai-menu.tech               │
│ → 阿里云ECS服务器 (¥200-300/月)                  │
│ → 需要域名备案（1-2周）                          │
│   如不备案可用IP: http://xxx.xxx.xxx.xxx:8080    │
└─────────────────────────────────────────────────┘
         ↓                    ↓                ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ PostgreSQL   │  │ Redis        │  │ 阿里云OSS    │
│ (RDS)        │  │ (Docker)     │  │ (文件存储)   │
│ ¥200-300/月  │  │ 免费         │  │ ¥10-50/月    │
└──────────────┘  └──────────────┘  └──────────────┘
```

### 部署特点

| 组件 | 平台 | 费用 | 是否需要备案 |
|------|------|------|-------------|
| 用户前端 | Vercel | 免费 | ❌ 不需要 |
| 管理后台 | Vercel | 免费 | ❌ 不需要 |
| 后端API | 阿里云ECS | ¥200-300/月 | ⚠️ 需要（或用IP） |
| 数据库 | 阿里云RDS | ¥200-300/月 | ❌ 不需要 |
| 文件存储 | 阿里云OSS | ¥10-50/月 | ❌ 不需要 |
| Redis | Docker自建 | 免费 | ❌ 不需要 |

**💰 总费用预估**：¥410-650/月

### ⚠️ 重要提示：未备案域名解决方案

由于 `ai-menu.tech` 是海外域名，**无法在中国备案**，使用 HTTPS 域名会被 GFW 干扰。

**当前生产环境配置（已验证可用）：**
```bash
# Vercel 环境变量
NEXT_PUBLIC_API_URL=http://8.140.9.139:8080

# 前端访问地址
用户端：https://app.ai-menu.tech
管理后台：https://admin.ai-menu.tech

# 后端 API 地址（不使用域名）
API：http://8.140.9.139:8080
```

**说明：**
- ✅ 前端使用 Vercel HTTPS（自带 SSL）
- ⚠️ 后端使用 IP + HTTP（因域名未备案）
- 🔐 如需后端 HTTPS，建议使用 Cloudflare CDN（免费，可绕过 GFW）

---

## 二、甲方需要准备的资源清单

### 2.1 域名（已有）
- ✅ `ai-menu.tech` - 已购买并使用中

### 2.2 阿里云账号（新建）

**需要创建以下服务**：

| 服务 | 规格建议 | 月费用 | 说明 |
|------|----------|--------|------|
| **ECS云服务器** | 2核4GB, 5Mbps带宽 | ¥200-300 | 部署后端 |
| **RDS PostgreSQL** | 2核4GB, 50GB存储 | ¥200-300 | 数据库 |
| **OSS对象存储** | 标准存储 | ¥10-50 | Excel文件存储 |

**需要获取的信息**：
```bash
# AccessKey（用于OSS访问）
OSS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxx
OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxx

# ECS服务器
ECS_IP=xxx.xxx.xxx.xxx
SSH登录密码或密钥

# RDS数据库连接
DATABASE_URL=postgres://用户名:密码@数据库地址:5432/ai_menu

# OSS配置
OSS_REGION=oss-cn-beijing
OSS_BUCKET=ai-menu-prod
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com
```

### 2.3 DeepSeek API（新建）

**申请步骤**：
1. 访问：https://platform.deepseek.com/
2. 注册账号
3. 充值（建议先充¥100测试）
4. 创建API Key

**需要获取**：
```bash
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxx
```

**费用预估**：¥50-200/月（按使用量）

### 2.4 Vercel账号（新建）

**申请步骤**：
1. 访问：https://vercel.com/
2. 使用GitHub账号登录
3. 授权访问代码仓库

**费用**：完全免费（Hobby计划）

### 2.5 GitHub仓库

确保代码已推送到GitHub仓库（Vercel部署需要）

---

## 三、部署前准备工作

### 3.1 代码准备

确认以下文件配置正确：

#### backend/.env (后端环境变量模板)
```bash
# 数据库
DATABASE_URL=postgres://ai_menu_admin:YOUR_PASSWORD@rm-xxxxx.pg.rds.aliyuncs.com:5432/ai_menu

# Redis
REDIS_URL=redis://localhost:6379
QUEUE_REDIS_URL=redis://localhost:6379

# 阿里云OSS
OSS_REGION=oss-cn-beijing
OSS_BUCKET=ai-menu-prod
OSS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxx
OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxx
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com

# DeepSeek AI
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
EMBEDDING_MODEL=deepseek-embedder
LLM_MODEL=deepseek-chat

# JWT (重要：生产环境必须改成随机字符串)
JWT_SECRET=请生成一个32位以上的随机字符串
JWT_EXPIRES_IN=7d

# 服务器
PORT=8080
NODE_ENV=production
HOST=0.0.0.0

# CORS（允许的前端域名）
CORS_ORIGIN=https://app.ai-menu.tech,https://admin.ai-menu.tech
```

#### 生成JWT_SECRET的方法
```bash
# 在任意终端执行（生成32位随机字符串）
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3.2 项目结构确认

```
ai-menu-100/
├── frontend/          # 用户前端 + 管理后台（统一部署）
│   ├── app/
│   │   ├── page.tsx              # 用户首页
│   │   ├── register/             # 注册
│   │   ├── login/                # 登录
│   │   └── admin/                # 管理后台
│   │       ├── dashboard/
│   │       ├── dishes/
│   │       ├── menus/
│   │       └── stores/
│   └── package.json
│
├── backend/           # 后端API
│   ├── src/
│   ├── database/
│   └── package.json
│
└── admin/             # ⚠️ 废弃目录，不需要部署
```

---

## 四、前端部署（Vercel）

### 4.1 部署前端到Vercel

#### 步骤1: 登录Vercel
1. 访问 https://vercel.com/
2. 点击 "Continue with GitHub"
3. 授权Vercel访问您的GitHub账号

#### 步骤2: 导入项目
1. 点击 "Add New..." → "Project"
2. 选择 `ai-menu-100` 仓库
3. 点击 "Import"

#### 步骤3: 配置构建设置

在项目配置页面填写：

```
Framework Preset: Next.js
Root Directory: frontend          ← 重要！
Build Command: pnpm build          ← 默认即可
Output Directory: .next            ← 默认即可
Install Command: pnpm install      ← 默认即可
```

#### 步骤4: 配置环境变量

在 "Environment Variables" 部分添加：

| Name | Value | 说明 |
|------|-------|------|
| `NEXT_PUBLIC_API_URL` | `https://api.ai-menu.tech` | 后端API地址（先填临时值） |

⚠️ **注意**：后端部署完成后需要更新这个值！

#### 步骤5: 部署
1. 点击 "Deploy"
2. 等待3-5分钟构建完成
3. 记录Vercel分配的临时域名（如：`ai-menu-100.vercel.app`）

### 4.2 配置自定义域名

#### 为用户前端配置域名（app.ai-menu.tech）

1. 在Vercel项目中，点击 "Settings" → "Domains"
2. 输入：`app.ai-menu.tech`
3. 点击 "Add"
4. Vercel会提示配置DNS记录

**DNS配置**：
- 类型：`CNAME`
- 主机记录：`app`
- 记录值：`cname.vercel-dns.com`
- TTL：10分钟

#### 为管理后台配置域名（admin.ai-menu.tech）

在同一个Vercel项目中：
1. 继续添加域名：`admin.ai-menu.tech`
2. 配置DNS记录：
   - 类型：`CNAME`
   - 主机记录：`admin`
   - 记录值：`cname.vercel-dns.com`
   - TTL：10分钟

#### 配置路由重定向（可选）

如果希望 `admin.ai-menu.tech` 直接跳转到登录页，需要在项目中添加配置：

在 `frontend/next.config.js` 中添加：
```javascript
async redirects() {
  return [
    {
      source: '/',
      destination: '/admin/login',
      permanent: false,
      has: [
        {
          type: 'host',
          value: 'admin.ai-menu.tech',
        },
      ],
    },
  ];
},
```

### 4.3 验证前端部署

访问以下URL测试：
- ✅ https://app.ai-menu.tech - 应显示用户首页
- ✅ https://admin.ai-menu.tech/admin/login - 应显示管理后台登录页

---

## 五、后端部署（阿里云ECS）

### 5.1 购买和配置ECS

#### 购买配置建议

| 配置项 | 推荐值 | 说明 |
|--------|--------|------|
| 地域 | 华北2（北京）或华东2（上海） | 靠近用户 |
| 实例规格 | 2核4GB | ecs.t6-c1m2.large |
| 镜像 | Ubuntu 22.04 | 稳定版 |
| 系统盘 | 40GB SSD | - |
| 网络 | 专有网络VPC | 安全性更好 |
| 公网IP | 固定IP | 必须 |
| 带宽 | 5Mbps | 按量付费 |

#### 安全组配置

放行以下端口：
- 22（SSH）
- 80（HTTP）
- 443（HTTPS）
- 8080（API端口，可选）

### 5.2 登录服务器并初始化

```bash
# 1. SSH登录（替换为实际IP）
ssh root@your_ecs_ip

# 2. 更新系统
apt update && apt upgrade -y

# 3. 安装基础工具
apt install -y curl git vim wget

# 4. 安装Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# 5. 安装pnpm
npm install -g pnpm

# 6. 安装Docker
curl -fsSL https://get.docker.com | bash
systemctl start docker
systemctl enable docker

# 7. 安装Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 8. 验证安装
node --version    # 应显示 v20.x
pnpm --version    # 应显示 pnpm版本
docker --version  # 应显示 Docker版本
```

### 5.3 部署后端代码

```bash
# 1. 创建项目目录
mkdir -p /opt/ai-menu
cd /opt/ai-menu

# 2. 克隆代码（替换为实际仓库地址）
git clone https://github.com/your-username/ai-menu-100.git .

# 3. 进入后端目录
cd backend

# 4. 安装依赖
pnpm install

# 5. 创建.env文件
vim .env
```

在.env文件中粘贴以下内容（**替换为实际值**）：
```bash
# 数据库（从阿里云RDS获取）
DATABASE_URL=postgres://ai_menu_admin:YOUR_PASSWORD@rm-xxxxx.pg.rds.aliyuncs.com:5432/ai_menu

# Redis（使用Docker本地）
REDIS_URL=redis://localhost:6379
QUEUE_REDIS_URL=redis://localhost:6379

# 阿里云OSS
OSS_REGION=oss-cn-beijing
OSS_BUCKET=ai-menu-prod
OSS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxx
OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxx
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com

# DeepSeek AI
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
EMBEDDING_MODEL=deepseek-embedder
LLM_MODEL=deepseek-chat

# JWT（生成随机值）
JWT_SECRET=your_generated_random_32_chars_string_here
JWT_EXPIRES_IN=7d

# 服务器
PORT=8080
NODE_ENV=production
HOST=0.0.0.0

# CORS
CORS_ORIGIN=https://app.ai-menu.tech,https://admin.ai-menu.tech
```

保存并退出（`:wq`）

### 5.4 启动Redis

```bash
# 1. 返回项目根目录
cd /opt/ai-menu/backend

# 2. 启动Redis容器
docker run -d \
  --name redis \
  --restart always \
  -p 6379:6379 \
  redis:7-alpine

# 3. 验证Redis运行
docker ps | grep redis
```

### 5.5 初始化数据库

```bash
cd /opt/ai-menu/backend

# 1. 运行初始化脚本（创建表结构）
pnpm tsx -r dotenv/config scripts/run-migration.ts

# 2. 创建管理员账号
pnpm tsx -r dotenv/config scripts/create-admin.ts

# 按提示输入：
# Username: admin
# Password: [设置强密码]
```

### 5.6 启动后端服务

#### 方法A：使用PM2（推荐，生产环境）

```bash
# 1. 全局安装PM2
npm install -g pm2

# 2. 启动后端
cd /opt/ai-menu/backend
pm2 start pnpm --name "ai-menu-backend" -- tsx src/server.ts

# 3. 设置开机自启
pm2 startup
pm2 save

# 4. 查看日志
pm2 logs ai-menu-backend

# 5. 其他常用命令
pm2 status              # 查看状态
pm2 restart ai-menu-backend   # 重启
pm2 stop ai-menu-backend      # 停止
```

#### 方法B：使用systemd（备选）

创建服务文件：
```bash
sudo vim /etc/systemd/system/ai-menu-backend.service
```

内容：
```ini
[Unit]
Description=AI Menu Backend
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/ai-menu/backend
Environment="NODE_ENV=production"
ExecStart=/usr/bin/pnpm tsx src/server.ts
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
systemctl daemon-reload
systemctl start ai-menu-backend
systemctl enable ai-menu-backend
systemctl status ai-menu-backend
```

### 5.7 配置Nginx反向代理（可选，推荐）

```bash
# 1. 安装Nginx
apt install -y nginx

# 2. 创建配置文件
vim /etc/nginx/sites-available/ai-menu-api
```

配置内容：
```nginx
server {
    listen 80;
    server_name api.ai-menu.tech;  # 或使用IP
    
    # 如果使用IP访问，注释掉上面的server_name
    
    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

启用配置：
```bash
# 创建软链接
ln -s /etc/nginx/sites-available/ai-menu-api /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 重启Nginx
systemctl restart nginx
systemctl enable nginx
```

### 5.8 配置HTTPS（域名备案后）

如果域名已备案，可以使用Let's Encrypt免费证书：

```bash
# 1. 安装certbot
apt install -y certbot python3-certbot-nginx

# 2. 申请证书（自动配置Nginx）
certbot --nginx -d api.ai-menu.tech

# 3. 自动续期
certbot renew --dry-run
```

Nginx会自动更新配置为HTTPS。

### 5.9 验证后端部署

```bash
# 1. 测试健康检查
curl http://localhost:8080/health

# 2. 测试登录API
curl -X POST http://localhost:8080/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"your_password"}'

# 应返回JWT token
```

如果通过Nginx：
```bash
curl http://your_ecs_ip/health
# 或
curl http://api.ai-menu.tech/health
```

---

## 六、数据库和服务配置

### 6.1 阿里云RDS PostgreSQL

#### 购买步骤
1. 登录阿里云控制台
2. 产品与服务 → 云数据库 RDS
3. 创建实例

#### 配置建议
```
地域: 华北2（北京）- 与ECS同区域
数据库类型: PostgreSQL
版本: 14或15
系列: 基础版（测试）或高可用版（生产）
规格: 2核4GB
存储: 50GB（按需调整）
网络: 专有网络VPC（与ECS同VPC）
```

#### 创建后配置

1. **设置白名单**
   - 添加ECS内网IP
   - 添加ECS公网IP（调试用）

2. **创建数据库账号**
   ```
   账号名: ai_menu_admin
   密码: [设置强密码，至少16位]
   权限: 读写
   ```

3. **创建数据库**
   ```
   数据库名: ai_menu
   字符集: UTF8
   ```

4. **获取连接地址**
   ```
   内网地址: rm-xxxxx.pg.rds.aliyuncs.com:5432
   外网地址: [可选开启]
   ```

5. **组装DATABASE_URL**
   ```
   postgres://ai_menu_admin:YOUR_PASSWORD@rm-xxxxx.pg.rds.aliyuncs.com:5432/ai_menu
   ```

### 6.2 阿里云OSS

#### 创建Bucket

1. 登录阿里云控制台
2. 对象存储OSS → Bucket列表 → 创建Bucket

#### Bucket配置
```
Bucket名称: ai-menu-prod（全局唯一）
地域: 华北2（北京）- 与ECS同区域
存储类型: 标准存储
读写权限: 私有（重要！）
服务端加密: 启用（可选）
```

#### 配置CORS

在Bucket设置中找到"跨域设置"，添加规则：

```json
{
  "allowedOrigins": [
    "https://app.ai-menu.tech",
    "https://admin.ai-menu.tech"
  ],
  "allowedMethods": [
    "GET",
    "POST",
    "PUT",
    "DELETE",
    "HEAD"
  ],
  "allowedHeaders": ["*"],
  "exposeHeaders": [
    "ETag",
    "x-oss-request-id"
  ],
  "maxAgeSeconds": 3600
}
```

#### 获取AccessKey

1. 右上角头像 → AccessKey管理
2. 创建AccessKey
3. **立即复制保存**（Secret只显示一次）

```
OSS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxx
OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxx
OSS_REGION=oss-cn-beijing
OSS_BUCKET=ai-menu-prod
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com
```

---

## 七、域名DNS配置

### 7.1 DNS记录配置

登录域名管理后台（如阿里云域名、腾讯云等），添加以下记录：

| 类型 | 主机记录 | 记录值 | TTL | 说明 |
|------|----------|--------|-----|------|
| CNAME | app | cname.vercel-dns.com | 600 | 用户前端 |
| CNAME | admin | cname.vercel-dns.com | 600 | 管理后台 |
| A | api | [ECS公网IP] | 600 | 后端API |

### 7.2 域名备案（api.ai-menu.tech）

如果要使用 `api.ai-menu.tech` 域名访问后端：

#### 备案流程
1. 登录阿里云控制台
2. 网站备案 → ICP备案
3. 填写主体信息（企业或个人）
4. 填写网站信息
5. 上传资料（身份证、营业执照等）
6. 等待审核（1-2周）

#### 如不备案的替代方案
直接使用ECS的IP地址访问：
```bash
# 前端环境变量改为
NEXT_PUBLIC_API_URL=http://[ECS_IP]:8080

# 或使用Nginx后
NEXT_PUBLIC_API_URL=http://[ECS_IP]
```

### 7.3 验证DNS生效

```bash
# 查询域名解析
nslookup app.ai-menu.tech
nslookup admin.ai-menu.tech
nslookup api.ai-menu.tech

# 或使用dig
dig app.ai-menu.tech
```

生效时间：通常5-10分钟

---

## 八、部署验证

### 8.1 后端验证

```bash
# 1. 健康检查
curl https://api.ai-menu.tech/health
# 期望返回: {"status":"ok"}

# 2. 登录API测试
curl -X POST https://api.ai-menu.tech/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"your_password"}'
# 期望返回: {"token":"eyJhbGc...","user":{...}}

# 3. 测试CORS
curl -X OPTIONS https://api.ai-menu.tech/api/admin/login \
  -H "Origin: https://app.ai-menu.tech" \
  -H "Access-Control-Request-Method: POST" \
  -v
# 期望返回: Access-Control-Allow-Origin头
```

### 8.2 前端验证

#### 用户端（app.ai-menu.tech）
- [ ] 访问首页正常显示
- [ ] 注册功能正常
- [ ] 登录功能正常
- [ ] 文件上传功能正常
- [ ] 菜单生成功能正常

#### 管理后台（admin.ai-menu.tech）
- [ ] 访问登录页正常
- [ ] 管理员登录成功
- [ ] Dashboard数据正常显示
- [ ] 菜品管理功能正常
- [ ] 菜单管理功能正常
- [ ] 门店管理功能正常

### 8.3 完整流程测试

**用户端流程**：
1. 访问 https://app.ai-menu.tech
2. 点击"注册" → 填写信息 → 注册成功
3. 上传历史菜单Excel → 解析成功
4. 配置菜品类型 → 保存成功
5. 点击"生成菜单" → 生成成功 → 下载Excel

**管理后台流程**：
1. 访问 https://admin.ai-menu.tech/admin/login
2. 使用admin账号登录
3. 查看Dashboard统计数据
4. 进入"菜品管理" → 查看所有菜品
5. 进入"用户管理" → 查看注册用户
6. 进入"门店管理" → 查看门店列表

### 8.4 性能测试

```bash
# 测试API响应时间
time curl https://api.ai-menu.tech/health

# 并发测试（可选，使用ab工具）
ab -n 100 -c 10 https://api.ai-menu.tech/health
```

---

## 九、常见问题

### 9.1 前端问题

#### Q1: Vercel部署失败
**原因**：构建错误或配置错误

**解决**：
1. 检查Root Directory是否设为`frontend`
2. 查看构建日志，找到具体错误
3. 确认package.json中的依赖完整

#### Q2: API请求失败，报CORS错误
**原因**：后端CORS配置不正确

**解决**：
检查后端.env文件中的CORS_ORIGIN：
```bash
CORS_ORIGIN=https://app.ai-menu.tech,https://admin.ai-menu.tech
```

确保没有多余空格，多个域名用逗号分隔。

#### Q3: 页面显示API_URL undefined
**原因**：环境变量未配置或未生效

**解决**：
1. 在Vercel项目设置中检查环境变量
2. 修改后需要点击"Redeploy"重新部署

### 9.2 后端问题

#### Q4: 后端启动失败，端口被占用
**原因**：8080端口被其他进程占用

**解决**：
```bash
# 查找占用端口的进程
lsof -i:8080

# 杀掉进程
kill -9 [PID]

# 或使用记忆中的命令
lsof -ti:8080 | xargs kill -9

# 重启后端
pm2 restart ai-menu-backend
```

#### Q5: 数据库连接失败
**原因**：DATABASE_URL配置错误或RDS白名单未设置

**解决**：
1. 检查DATABASE_URL格式：
   ```
   postgres://用户名:密码@地址:5432/数据库名
   ```
2. 确认RDS白名单包含ECS的IP
3. 测试连接：
   ```bash
   psql "postgres://ai_menu_admin:PASSWORD@rm-xxxxx.pg.rds.aliyuncs.com:5432/ai_menu"
   ```

#### Q6: OSS上传失败
**原因**：AccessKey错误或Bucket权限问题

**解决**：
1. 检查AccessKey是否正确
2. 确认Bucket名称正确
3. 检查Bucket的读写权限设置
4. 查看后端日志：
   ```bash
   pm2 logs ai-menu-backend
   ```

### 9.3 性能问题

#### Q7: 国内访问API很慢
**原因**：ECS地域选择不当或带宽不足

**解决**：
1. 确认ECS在国内（华北、华东等）
2. 升级带宽（5Mbps → 10Mbps）
3. 使用CDN加速（可选）

#### Q8: Vercel访问慢或不稳定
**原因**：Vercel在某些地区访问不稳定

**解决方案**：
1. 换用阿里云OSS+CDN部署前端（需要重新配置）
2. 使用国内服务器反向代理Vercel
3. 联系用户更换网络环境

### 9.4 安全问题

#### Q9: 如何防止SQL注入？
**当前方案**：
- 使用参数化查询（已实现）
- 使用ORM（如需要可迁移到Prisma）

#### Q10: JWT_SECRET泄露怎么办？
**解决**：
1. 立即更换JWT_SECRET（生成新的随机字符串）
2. 重启后端服务
3. 所有用户需要重新登录

---

## 十、维护和监控

### 10.1 日常维护

#### 查看后端日志
```bash
# PM2方式
pm2 logs ai-menu-backend

# systemd方式
journalctl -u ai-menu-backend -f
```

#### 查看系统资源
```bash
# CPU和内存
top

# 磁盘空间
df -h

# Docker容器状态
docker ps
```

#### 数据库备份
```bash
# 手动备份
pg_dump "postgres://ai_menu_admin:PASSWORD@rm-xxxxx.pg.rds.aliyuncs.com:5432/ai_menu" > backup_$(date +%Y%m%d).sql

# 或使用阿里云RDS自动备份（推荐）
# 在RDS控制台设置自动备份策略
```

### 10.2 更新部署

#### 更新前端
```bash
# Vercel会自动监听GitHub推送
git push origin main

# 或手动触发部署
# 在Vercel项目页面点击 "Deployments" → "Redeploy"
```

#### 更新后端
```bash
# 1. SSH登录服务器
ssh root@your_ecs_ip

# 2. 拉取最新代码
cd /opt/ai-menu
git pull origin main

# 3. 安装新依赖（如有）
cd backend
pnpm install

# 4. 运行数据库迁移（如有）
pnpm tsx scripts/run-migration.ts

# 5. 重启服务
pm2 restart ai-menu-backend

# 6. 查看日志确认
pm2 logs ai-menu-backend --lines 100
```

### 10.3 监控指标

建议监控以下指标：
- [ ] API响应时间
- [ ] 数据库连接数
- [ ] Redis内存使用
- [ ] OSS存储空间
- [ ] ECS CPU和内存使用率
- [ ] 错误日志数量

可选：使用阿里云云监控（免费）或第三方服务（如Sentry）。

---

## 十一、费用总结

### 11.1 月费用明细

| 服务 | 规格 | 月费用 | 备注 |
|------|------|--------|------|
| 阿里云ECS | 2核4GB, 5Mbps | ¥200-300 | 可按需升级 |
| 阿里云RDS | 2核4GB, 50GB | ¥200-300 | 基础版更便宜 |
| 阿里云OSS | 标准存储 | ¥10-50 | 按实际使用 |
| DeepSeek API | - | ¥50-200 | 按使用量 |
| Vercel | Hobby | ¥0 | 免费 |
| **总计** | - | **¥460-850/月** | - |

### 11.2 成本优化建议

1. **ECS**：使用包年包月（比按量付费便宜20-30%）
2. **RDS**：测试阶段可用基础版（比高可用版便宜50%）
3. **OSS**：启用生命周期管理，自动删除过期文件
4. **带宽**：按实际需求调整，不需要预留太多

---

## 十二、技术支持

### 部署过程中遇到问题？

1. **查看文档**：本文档已覆盖90%的常见问题
2. **查看日志**：大部分问题可通过日志定位
3. **GitHub Issues**：在项目仓库提Issue
4. **联系开发者**：lyratng@163.com

---

## 十三、检查清单

部署完成后，请逐项检查：

### 基础设施
- [ ] 阿里云账号已创建
- [ ] ECS服务器已购买并初始化
- [ ] RDS数据库已创建并配置
- [ ] OSS Bucket已创建并配置CORS
- [ ] DeepSeek API Key已获取
- [ ] Vercel账号已创建

### 后端部署
- [ ] 代码已部署到ECS
- [ ] .env文件已正确配置
- [ ] Redis容器已启动
- [ ] 数据库表已初始化
- [ ] 管理员账号已创建
- [ ] 后端服务已启动（PM2）
- [ ] Nginx已配置（可选）
- [ ] HTTPS证书已配置（备案后）

### 前端部署
- [ ] Vercel项目已创建
- [ ] Root Directory设为frontend
- [ ] 环境变量已配置
- [ ] 构建成功
- [ ] app.ai-menu.tech域名已绑定
- [ ] admin.ai-menu.tech域名已绑定

### DNS配置
- [ ] app CNAME记录已添加
- [ ] admin CNAME记录已添加
- [ ] api A记录已添加（或使用IP）
- [ ] DNS已生效（nslookup验证）

### 功能测试
- [ ] 用户端首页可访问
- [ ] 管理后台登录页可访问
- [ ] API健康检查通过
- [ ] 用户注册功能正常
- [ ] 文件上传功能正常
- [ ] 菜单生成功能正常
- [ ] 管理后台所有功能正常

### 安全检查
- [ ] JWT_SECRET已更换为随机值
- [ ] 数据库密码强度足够
- [ ] OSS Bucket权限为私有
- [ ] CORS配置正确
- [ ] ECS安全组配置合理

---

**🎉 恭喜！如果所有检查项都通过，您的AI菜单系统已成功部署上线！**

访问地址：
- 👥 用户端：https://app.ai-menu.tech
- 🔐 管理后台：https://admin.ai-menu.tech
- 🚀 API：https://api.ai-menu.tech

---

*最后更新：2025-11-11*
*版本：v1.0*

