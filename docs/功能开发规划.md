# 炊语智能菜单生成系统 - 功能开发规划

## 📊 当前进度总览

### ✅ 已完成功能

#### 1. 基础架构
- [x] Monorepo项目结构（frontend, admin, backend, shared）
- [x] PostgreSQL数据库设计和初始化
- [x] TypeScript类型定义
- [x] 基础API框架（Fastify）
- [x] 前端框架（Next.js）
- [x] UI组件库（shadcn/ui）

#### 2. 用户端（frontend）
- [x] 注册登录界面（基础版）
- [x] 二次登录界面
- [x] 主页基础布局
- [x] 午餐容器4个书签切换
- [x] 午餐生成选项（7个选项全部）
- [x] 菜单生成API对接
- [x] 菜单表格渲染（5天）
- [x] 菜品详情弹窗（DishDetailDialog）

#### 3. 后端（backend）
- [x] 用户认证（注册/登录）
- [x] JWT中间件
- [x] 菜单生成核心逻辑
- [x] DeepSeek API集成
- [x] 菜品数据库查询
- [x] 菜单保存到数据库

#### 4. 数据库
- [x] 完整表结构（13张表）
- [x] 229道初始菜品数据
- [x] 菜品类型和标签规范化

---

## 🔄 待完成功能（按优先级排序）

### 🔴 P0 - 核心功能（必须实现）

#### 1. 历史菜单上传和解析 ⭐⭐⭐
**优先级**：最高  
**预计时间**：8-12小时  
**依赖**：DeepSeek API（需要解决连接问题）

**功能点**：
- [ ] 【前端】首次注册界面-2：Excel上传组件
- [ ] 【前端】解析状态栏（固定悬浮）
- [ ] 【前端】解析队列详情展开/收起
- [ ] 【前端】"重新解析"按钮
- [ ] 【后端】Excel文件解析（XLSX）
- [ ] 【后端】异步解析队列（BullMQ + Redis）
- [ ] 【后端】AI解析菜单（提示词已在PRD）
- [ ] 【后端】自动写入dishes_store和menus表
- [ ] 【前端】实时解析状态更新（轮询或WebSocket）

**PRD位置**：第773-791行

**技术要点**：
- 使用 `xlsx` 库解析Excel
- 使用 `BullMQ` 实现异步队列
- 每份菜单触发一个解析任务
- 解析结果存储：
  - `dishes_store` - 菜品（analysis.status='uploaded_by_user'）
  - `menus` - 菜单（source_type='uploaded'）
- 状态轮询：每3秒查询一次 `meta_json.pipeline_status`

---

#### 2. 历史菜单查看页面 ⭐⭐
**优先级**：高  
**预计时间**：4-6小时  
**依赖**：历史菜单上传功能

**功能点**：
- [ ] 【前端】历史菜单页面路由（/history）
- [ ] 【前端】两个Tab：历史生成菜单 / 历史上传菜单
- [ ] 【前端】历史生成菜单列表（最近10次）
- [ ] 【前端】历史上传菜单列表（1-50份）
- [ ] 【前端】菜单表格展示（复用MenuDialog）
- [ ] 【前端】上传菜单的删除功能（软删除）
- [ ] 【前端】继续上传更多菜单（最多50份）
- [ ] 【后端】查询历史菜单API
- [ ] 【后端】软删除菜单API

**PRD位置**：第994-1000行

**技术要点**：
- Tab切换组件（shadcn/ui Tabs）
- 菜单列表展示（Card + Table）
- 软删除：更新 `is_active=false`
- 限制：每个门店最多50份上传菜单

---

#### 3. 首次注册界面完善 ⭐
**优先级**：中高  
**预计时间**：3-4小时

**功能点**：
- [ ] 【前端】菜品数量初始化配置（可折叠）
  - 早餐（默认折叠）
  - 午餐（默认展开）
  - 晚餐（默认折叠）
  - 夜宵（默认折叠）
- [ ] 【前端】每个类别的数量输入框（+/- 按钮）
- [ ] 【前端】保存按钮 → 进入注册界面-2
- [ ] 【后端】保存用户配置到stores表（default_config字段）

**PRD位置**：第738-771行

**技术要点**：
- 使用shadcn/ui Accordion组件（可折叠）
- 默认值按PRD配置
- 保存到 `stores.default_config` JSONB字段

---

### 🟡 P1 - 增强功能（应该实现）

#### 4. 管理员后台基础框架 ⭐⭐
**优先级**：中  
**预计时间**：6-8小时

**功能点**：
- [ ] 【Admin前端】管理员登录页面
- [ ] 【Admin前端】左侧导航栏（9个菜单项）
- [ ] 【Admin前端】顶部Header（用户信息、退出登录）
- [ ] 【Admin前端】Dashboard空白页占位
- [ ] 【后端】管理员认证API
- [ ] 【后端】管理员角色权限检查

**PRD位置**：第1002-1031行

**技术要点**：
- 独立的admin项目（已创建）
- 域名：admin.ai-menu.tech
- 角色：admin（区别于store_manager）
- 左侧导航：Dashboard、Stores、Menus、Dishes、Accounts、Audit Log、Import/Export、API Tokens、Settings

---

#### 5. 管理员Dashboard概览看板 ⭐⭐
**优先级**：中  
**预计时间**：8-10小时  
**依赖**：管理员基础框架

**功能点**：
- [ ] 【Admin前端】时间筛选器（7/30/90天/自定义）
- [ ] 【Admin前端】6个KPI卡片
- [ ] 【Admin前端】5个图表
  - 时间序列折线（生成vs上传）
  - 柱状排名（TOP10高频菜）
  - 环形占比（8大烹饪法）
  - 条形图（辣度档位）
  - 堆叠柱（菜品结构分布）
- [ ] 【Admin前端】全局筛选器
- [ ] 【Admin前端】导出功能（Excel/CSV/PDF）
- [ ] 【后端】Dashboard指标聚合API
- [ ] 【后端】图表数据生成API

**PRD位置**：第1032-1076行

**技术要点**：
- KPI：活跃门店数、新增门店数、生成菜单数、上传菜单数、留存率、失败率
- 使用Recharts图表库
- 数据聚合：PostgreSQL聚合查询 + 可选Redis缓存

---

#### 6. 管理员门店管理 ⭐
**优先级**：中  
**预计时间**：6-8小时  
**依赖**：管理员基础框架

**功能点**：
- [ ] 【Admin前端】门店列表（分页）
- [ ] 【Admin前端】新增门店
- [ ] 【Admin前端】编辑门店信息
- [ ] 【Admin前端】修改门店初始化配置
- [ ] 【Admin前端】禁用/启用门店
- [ ] 【Admin前端】软删除门店
- [ ] 【Admin前端】批量导入门店（Excel）
- [ ] 【Admin前端】批量导出门店
- [ ] 【后端】门店CRUD API
- [ ] 【后端】批量导入/导出逻辑

**PRD位置**：第1077-1101行

**技术要点**：
- 服务端分页：pageSize=50
- 搜索：按名称/账号模糊搜索
- 软删除：is_active=false
- 批量导入：Excel模板（store_name, login, password）

---

### 🟢 P2 - 优化功能（可以实现）

#### 7. 菜单下载Excel功能
**优先级**：中低  
**预计时间**：2-3小时

**功能点**：
- [ ] 【前端】MenuDialog右上角"下载Excel"按钮
- [ ] 【前端】生成Excel文件（xlsx库）
- [ ] 【前端】格式：周一到周五横轴，菜品类型纵轴

**PRD位置**：第986行

**技术要点**：
- 使用 `xlsx` 库
- 客户端生成Excel
- 文件名：`菜单_${date}.xlsx`

---

#### 8. 管理员菜单库管理
**优先级**：低  
**预计时间**：5-6小时

**功能点**：
- [ ] 【Admin前端】菜单列表（分页、筛选）
- [ ] 【Admin前端】菜单详情查看
- [ ] 【Admin前端】菜单软删除
- [ ] 【Admin前端】菜单导出
- [ ] 【后端】菜单查询API（支持复杂筛选）

**PRD位置**：第1102-1120行

---

#### 9. 管理员菜品库管理
**优先级**：低  
**预计时间**：5-6小时

**功能点**：
- [ ] 【Admin前端】菜品列表（分页、筛选）
- [ ] 【Admin前端】菜品详情查看
- [ ] 【Admin前端】菜品合并工具
- [ ] 【Admin前端】菜品软删除
- [ ] 【Admin前端】菜品导出
- [ ] 【后端】菜品查询API
- [ ] 【后端】菜品合并逻辑

**PRD位置**：第1121-1139行

---

#### 10. 审计日志
**优先级**：低  
**预计时间**：4-5小时

**功能点**：
- [ ] 【Admin前端】审计日志列表
- [ ] 【Admin前端】日志筛选（对象类型、操作者、时间）
- [ ] 【Admin前端】日志导出
- [ ] 【后端】审计日志记录中间件
- [ ] 【后端】审计日志查询API

**PRD位置**：第1154-1171行

---

## 🎯 推荐开发顺序

### 阶段1：完成用户端核心功能（1-2周）
1. ✅ 注册登录（已完成）
2. ✅ 主页和菜单生成（已完成）
3. 🔄 **首次注册界面完善**（P0-3）- 下一步
4. 🔄 **历史菜单上传和解析**（P0-1）- 重点
5. 🔄 **历史菜单查看页面**（P0-2）

**目标**：用户端基本可用，用户可以注册、登录、生成菜单、上传历史菜单

---

### 阶段2：管理员后台基础（1周）
6. 🔄 **管理员后台基础框架**（P1-4）
7. 🔄 **管理员门店管理**（P1-6）
8. 🔄 **管理员Dashboard概览**（P1-5）

**目标**：管理员可以查看数据、管理门店

---

### 阶段3：管理员后台增强（1周）
9. 🔄 管理员菜单库管理（P2-8）
10. 🔄 管理员菜品库管理（P2-9）
11. 🔄 审计日志（P2-10）

**目标**：管理员功能完善

---

### 阶段4：优化和完善（3-5天）
12. 🔄 菜单下载Excel功能（P2-7）
13. 🔄 UI/UX优化
14. 🔄 性能优化
15. 🔄 测试和修复Bug

**目标**：系统稳定、体验良好

---

## ⚠️ 当前问题和临时方案

### 问题1：DeepSeek API连接不稳定（ECONNRESET）

**现状**：
- 菜单生成功能会因为DeepSeek API连接问题失败
- 已增加重试次数（6次）和延迟（3秒）
- 但仍然可能失败

**临时方案**：
1. **跳过菜单生成测试**，先完成其他功能
2. 后续使用模拟数据测试前端渲染
3. 等DeepSeek服务稳定后再测试完整流程

**长期方案**：
1. 增加OpenAI API作为备用
2. 实现兜底菜单策略（规则生成）
3. 添加更详细的错误提示和用户引导

---

## 📋 立即开始：首次注册界面完善

**为什么先做这个？**
1. 不依赖DeepSeek API
2. 是用户注册流程的必需功能
3. 为后续历史菜单上传功能打基础
4. 纯前端+简单后端，风险低

**具体任务**：
- [ ] 创建注册界面-1（菜品数量配置）
- [ ] 创建注册界面-2（历史菜单上传）
- [ ] 修改注册流程路由
- [ ] 后端保存用户配置

**开始时间**：立即  
**预计完成**：3-4小时

---

## 下一步行动

我建议立即开始实现：

### ✨ 首次注册界面完善（P0-3）

1. **创建新页面**：`frontend/app/register-config/page.tsx`
2. **实现功能**：
   - 可折叠的菜品数量配置
   - 保存按钮 → 进入注册界面-2
3. **修改注册流程**：
   - 当前：注册 → 登录 → 主页
   - 新流程：注册 → 配置 → 上传（可跳过）→ 主页

---

**请确认：是否开始实现"首次注册界面完善"？**

或者你想先做其他功能？

