# **0) 快速总览（域名与组件拓扑）**





- **用户前端（Next.js/Vercel）**：app.ai-menu.tech（你现有的继续用）
- **后端 API（ECS）**：api.ai-menu.tech
- **Admin 后台（Next.js/部署到 Vercel 或 ECS 均可）**：admin.ai-menu.tech
- **数据看板（Metabase 容器，跑在 ECS）**：bi.ai-menu.tech
- **对象存储**：阿里云 OSS（同区域：华北2北京）
- **数据库**：阿里云 RDS PostgreSQL（华北2）
- **日志**：阿里云日志服务 SLS（华北2）
- **消息/缓存**：Redis（容器内先跑，后续可切云 Redis）
- **A/B 策略**：企业维度 50/50，评估周期 2 周
- **SLA 目标**：可用性 99.5%，RTO 30min，RPO 24h
- **备份**：RDS 自动快照保留 **90 天**





------

# **1) 技术栈与项目结构（Monorepo）**

## **1.1 技术栈总览**

### **前端技术栈**

**用户前端 (app.ai-menu.tech)**
- 框架：Next.js 14+ (App Router)
- 语言：TypeScript 5+
- 样式：Tailwind CSS 3+
- UI组件：shadcn/ui（极简风格）
- 状态管理：Zustand（轻量级状态管理）
- 数据请求：TanStack Query (React Query)（自动缓存、轮询）
- 表单验证：React Hook Form + Zod
- Excel导入导出：SheetJS (xlsx)
- 部署：Vercel（国内CDN可用）

**管理后台 (admin.ai-menu.tech)**
- 框架：Next.js 14+ (App Router)
- 语言：TypeScript 5+
- 样式：Tailwind CSS 3+
- UI组件：shadcn/ui（极简风格）
- 状态管理：Zustand
- 数据请求：TanStack Query
- 表单验证：React Hook Form + Zod
- 表格：TanStack Table（支持服务端分页、筛选、排序）
- 图表：Recharts（Dashboard数据可视化）
- Excel导入导出：SheetJS (xlsx)
- 部署：Vercel（独立项目）

### **后端技术栈**

**API服务 (api.ai-menu.tech)**
- 框架：Fastify 4+
- 语言：TypeScript 5+
- 数据库：PostgreSQL 14+ (pg驱动)
- 向量搜索：pgvector扩展
- 缓存：Redis 7+
- 认证：JWT (jsonwebtoken)
- 密码加密：bcrypt
- 文件存储：阿里云OSS SDK
- AI调用：
  - DeepSeek API（主要）
  - OpenAI API（预留接口）
- 队列：BullMQ + Redis（异步解析任务）
- 日志：Pino（高性能日志）
- 部署：Docker + docker-compose（阿里云ECS）

### **共享类型库 (shared/)**
- 语言：TypeScript 5+
- 内容：前后端共享的类型定义、工具函数

### **基础设施**
- 数据库：阿里云RDS PostgreSQL（华北2北京）
- 对象存储：阿里云OSS（华北2北京）
- 容器：阿里云ECS + Docker
- 域名解析：阿里云DNS
- CDN：Vercel CDN（前端）
- 日志：阿里云SLS（可选）

---

## **1.2 Monorepo 项目结构（完整拓扑）**

```
ai-menu-100/
├── frontend/                    # 用户前端 (Next.js)
│   ├── app/                    # App Router页面
│   │   ├── (auth)/            # 认证相关页面组
│   │   │   ├── login/
│   │   │   └── register/
│   │   ├── (main)/            # 主应用页面组
│   │   │   ├── home/          # 主页（生成菜单）
│   │   │   └── history/       # 历史菜单
│   │   ├── layout.tsx
│   │   └── page.tsx
│   ├── components/             # React组件
│   │   ├── ui/                # shadcn/ui基础组件
│   │   ├── menu/              # 菜单相关组件
│   │   ├── upload/            # 上传组件
│   │   └── ...
│   ├── lib/                   # 工具函数
│   │   ├── api.ts            # API请求封装
│   │   ├── utils.ts
│   │   └── ...
│   ├── hooks/                 # 自定义Hooks
│   ├── stores/                # Zustand状态管理
│   ├── public/                # 静态资源
│   ├── styles/                # 全局样式
│   ├── package.json
│   ├── tsconfig.json
│   ├── tailwind.config.ts
│   ├── next.config.js
│   └── .env.local
│
├── admin/                      # 管理后台 (Next.js)
│   ├── app/
│   │   ├── (auth)/
│   │   │   └── login/
│   │   ├── (dashboard)/       # 主应用页面组
│   │   │   ├── dashboard/     # 概览看板
│   │   │   ├── stores/        # 门店管理
│   │   │   ├── menus/         # 菜单库
│   │   │   ├── dishes/        # 菜品库
│   │   │   ├── accounts/      # 账号管理
│   │   │   ├── audit/         # 审计日志
│   │   │   ├── import-export/ # 导入导出
│   │   │   ├── api-tokens/    # API访问
│   │   │   └── settings/      # 系统设置
│   │   ├── layout.tsx
│   │   └── page.tsx
│   ├── components/
│   │   ├── ui/
│   │   ├── charts/            # 图表组件
│   │   ├── tables/            # 表格组件
│   │   └── ...
│   ├── lib/
│   ├── hooks/
│   ├── stores/
│   ├── package.json
│   ├── tsconfig.json
│   ├── tailwind.config.ts
│   └── next.config.js
│
├── backend/                    # 后端API (Fastify)
│   ├── src/
│   │   ├── config/            # 配置文件
│   │   │   └── env.ts
│   │   ├── db/                # 数据库
│   │   │   ├── pool.ts        # PostgreSQL连接池
│   │   │   └── migrations/    # 数据库迁移脚本
│   │   ├── routes/            # API路由
│   │   │   ├── auth.ts        # 认证相关
│   │   │   ├── menu.ts        # 菜单生成
│   │   │   ├── dish.ts        # 菜品管理
│   │   │   ├── upload.ts      # 文件上传
│   │   │   ├── admin.ts       # 管理员接口
│   │   │   └── ...
│   │   ├── services/          # 业务逻辑
│   │   │   ├── embeddings.ts  # Embedding服务
│   │   │   ├── rag.ts         # RAG检索（预留）
│   │   │   ├── menu.ts        # 菜单生成逻辑
│   │   │   ├── parser.ts      # Excel解析
│   │   │   └── ai/            # AI调用
│   │   │       ├── deepseek.ts
│   │   │       └── openai.ts
│   │   ├── workers/           # 后台任务
│   │   │   ├── parseMenu.ts   # 菜单解析队列
│   │   │   └── queue.ts       # BullMQ配置
│   │   ├── middleware/        # 中间件
│   │   │   ├── auth.ts        # JWT验证
│   │   │   └── error.ts       # 错误处理
│   │   ├── utils/             # 工具函数
│   │   │   ├── oss.ts         # OSS上传
│   │   │   ├── hash.ts        # 密码加密
│   │   │   └── ...
│   │   ├── types/             # TypeScript类型
│   │   └── server.ts          # 入口文件
│   ├── package.json
│   ├── tsconfig.json
│   ├── Dockerfile
│   ├── docker-compose.yml
│   ├── nginx.conf
│   └── .env.example
│
├── shared/                     # 共享代码
│   ├── types/                 # 共享类型定义
│   │   ├── dish.ts           # 菜品类型
│   │   ├── menu.ts           # 菜单类型
│   │   ├── user.ts           # 用户类型
│   │   ├── api.ts            # API请求/响应类型
│   │   └── index.ts
│   ├── utils/                 # 共享工具函数
│   │   └── index.ts
│   ├── constants/             # 共享常量
│   │   ├── cookMethods.ts    # 8大烹饪法
│   │   ├── dishTypes.ts      # 菜品类型枚举
│   │   └── index.ts
│   ├── package.json
│   └── tsconfig.json
│
├── docs/                       # 项目文档
│   ├── 项目框架.md
│   ├── 炊语智能菜单生成系统 PRD.md
│   ├── API文档.md            # API接口文档
│   ├── 数据库设计.md          # 数据库详细设计
│   ├── 部署指南.md            # 部署步骤
│   └── 第三方服务配置.md      # 阿里云等服务配置指南
│
├── scripts/                    # 脚本工具
│   ├── init-db.sql           # 数据库初始化脚本
│   └── seed-data.ts          # 测试数据生成
│
├── .gitignore
├── package.json               # 根package.json (pnpm workspace)
├── pnpm-workspace.yaml        # pnpm workspace配置
├── tsconfig.json              # 根TypeScript配置
└── README.md
```

---

## **1.3 部署架构与数据流向**

### **架构图**

```
用户操作流程：
┌─────────────────┐
│   用户浏览器     │
│ app.ai-menu.tech│
└────────┬────────┘
         │ HTTPS
         ▼
┌─────────────────┐      ┌──────────────┐
│  Vercel CDN     │─────▶│ Next.js SSR  │
│  (中国节点)      │      │  (frontend)  │
└─────────────────┘      └──────┬───────┘
                                │ Fetch API
                                ▼
                         ┌─────────────┐
                         │ api.ai-menu │
                         │  .tech      │
                         │  (Fastify)  │
                         └──────┬──────┘
                                │
                    ┌───────────┼───────────┐
                    ▼           ▼           ▼
            ┌──────────┐ ┌─────────┐ ┌──────────┐
            │   RDS    │ │  Redis  │ │ OSS存储  │
            │PostgreSQL│ │  队列   │ │  文件    │
            └──────────┘ └─────────┘ └──────────┘
                    ▲
                    │ 调用AI API
                    ▼
            ┌──────────────┐
            │ DeepSeek API │
            │ (国内可用)    │
            └──────────────┘

管理员操作流程：
┌─────────────────┐
│  管理员浏览器    │
│admin.ai-menu.tech│
└────────┬────────┘
         │ HTTPS
         ▼
┌─────────────────┐      ┌──────────────┐
│  Vercel CDN     │─────▶│ Next.js SSR  │
│  (中国节点)      │      │   (admin)    │
└─────────────────┘      └──────┬───────┘
                                │ Fetch API
                                ▼
                         ┌─────────────┐
                         │ api.ai-menu │
                         │  .tech      │
                         │  (Fastify)  │
                         └─────────────┘
                            (同一个后端)
```

---

------





# **2) PostgreSQL DDL（复制即用）**





> 说明：



- > 使用 **pgvector**；

- > 两级多租户（org→store），账号=食堂名；

- > 午餐先做，但早餐/晚餐字段保留；

- > 历史上传 Excel 解析入库，原始文件进 OSS；

- > 双索引：doc_type in ('dish','menu','price')；

- > 事件与指标表齐全；

- > 简化权限：四角色（admin、org_admin、store_manager、viewer）。

```sql
-- 必须：启用扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS vector;  -- pgvector

-- 组织/门店
CREATE TABLE orgs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE stores (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES orgs(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  code TEXT, -- 可选门店编码
  address TEXT,
  timezone TEXT DEFAULT 'Asia/Shanghai',
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(org_id, name)
);

-- 用户/账号（账号=食堂名，亦可独立设置）
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID REFERENCES orgs(id) ON DELETE SET NULL,
  store_id UUID REFERENCES stores(id) ON DELETE SET NULL,
  username TEXT NOT NULL UNIQUE,         -- 账号名（建议=食堂名或门店名）
  password_hash TEXT NOT NULL,           -- Bcrypt/Argon2
  email TEXT,                            -- 可为空（你当前不用邮箱登录也行）
  role TEXT NOT NULL CHECK (role IN ('admin','org_admin','store_manager','viewer')),
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- OSS 文件登记（历史上传等）
CREATE TABLE files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID REFERENCES orgs(id) ON DELETE SET NULL,
  store_id UUID REFERENCES stores(id) ON DELETE SET NULL,
  uploader_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  oss_bucket TEXT NOT NULL,
  oss_key TEXT NOT NULL,                 -- 路径
  original_name TEXT,
  mime_type TEXT,
  size_bytes BIGINT,
  purpose TEXT,                          -- e.g. 'history_menu_upload'
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 主数据：菜品
CREATE TABLE dishes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  standard_name TEXT NOT NULL,           -- 标准中文名
  aliases TEXT[] DEFAULT '{}',           -- 别名
  method TEXT,                           -- 工艺
  flavor TEXT,                           -- 风味
  region TEXT,                           -- 菜系/地域
  equipment TEXT[],                      -- 设备
  cost_level TEXT,                        -- 低/中/高（未来细化）
  season TEXT,                            -- 春/夏/秋/冬/四季
  allergens TEXT[],                       -- 过敏原
  tags TEXT[] DEFAULT '{}',               -- 其他标签
  meta_json JSONB DEFAULT '{}'::jsonb,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  updated_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(standard_name)
);

-- 价格/物流（先留表，暂不更新）
CREATE TABLE price_logistics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID REFERENCES orgs(id) ON DELETE SET NULL,
  region TEXT,
  ingredient TEXT NOT NULL,
  unit TEXT,                              -- kg/斤/箱
  price NUMERIC(12,2),
  vendor TEXT,
  collected_at DATE,                      -- 采集日期
  source TEXT,                            -- 数据来源
  meta_json JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 门店偏好（过敏/禁忌/辣度等）
CREATE TABLE store_preferences (
  store_id UUID PRIMARY KEY REFERENCES stores(id) ON DELETE CASCADE,
  allergens_blacklist TEXT[] DEFAULT '{}',
  dislike_tags TEXT[] DEFAULT '{}',
  spicy_level TEXT,                       -- 不辣/微辣/中辣...
  equipment_constraints JSONB DEFAULT '{}'::jsonb,  -- 设备紧缺
  meta_json JSONB DEFAULT '{}'::jsonb,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 菜单（生成结果）
CREATE TABLE menus (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID REFERENCES orgs(id) ON DELETE SET NULL,
  store_id UUID REFERENCES stores(id) ON DELETE SET NULL,
  title TEXT,                             -- 可选
  -- 仅做午餐，但结构保留三餐
  days INT NOT NULL DEFAULT 5,            -- 5天
  lunch_items_json JSONB NOT NULL,        -- 主体：按你的输出结构存
  breakfast_items_json JSONB DEFAULT '[]'::jsonb,
  dinner_items_json JSONB DEFAULT '[]'::jsonb,
  source_type TEXT NOT NULL CHECK (source_type IN ('user_history','internal_library','hybrid')),
  generated_by TEXT,                      -- model/provider
  notes TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- RAG 文档与向量（双索引）
CREATE TABLE rag_documents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID REFERENCES orgs(id) ON DELETE SET NULL, -- 公共库可空
  doc_type TEXT NOT NULL CHECK (doc_type IN ('dish','menu','price')),
  source_id UUID,                        -- 指向 dishes/menus/price_logistics
  title TEXT,
  text TEXT,                             -- 可为规范化文本/展开特征
  meta_json JSONB DEFAULT '{}'::jsonb,
  index_version TEXT DEFAULT 'v1',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 向量（注意：dim与模型一致）
-- 以 1536 维为例（qwen-emb）
CREATE TABLE rag_embeddings (
  doc_id UUID PRIMARY KEY REFERENCES rag_documents(id) ON DELETE CASCADE,
  embedding vector(1536),
  model TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX ON rag_documents (doc_type);
CREATE INDEX ON rag_documents USING GIN ((meta_json));
CREATE INDEX ON rag_embeddings USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

-- 事件与埋点
CREATE TABLE auth_event (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  type TEXT NOT NULL CHECK (type IN ('signup','login','logout')),
  ip INET,
  ua TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  meta_json JSONB DEFAULT '{}'::jsonb
);

CREATE TABLE generation_event (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID REFERENCES orgs(id) ON DELETE SET NULL,
  store_id UUID REFERENCES stores(id) ON DELETE SET NULL,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  menu_id UUID REFERENCES menus(id) ON DELETE SET NULL,
  status TEXT NOT NULL CHECK (status IN ('success','failed','partial')),
  latency_ms INT,
  model TEXT,
  prompt_tokens INT,
  output_tokens INT,
  ab_group TEXT,                          -- 'A' or 'B'
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  meta_json JSONB DEFAULT '{}'::jsonb
);

CREATE TABLE usage_event (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID REFERENCES orgs(id) ON DELETE SET NULL,
  store_id UUID REFERENCES stores(id) ON DELETE SET NULL,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  event_type TEXT NOT NULL,               -- e.g. 'menu_view','menu_export','mark_executed'
  event_value TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  meta_json JSONB DEFAULT '{}'::jsonb
);

-- A/B 实验
CREATE TABLE ab_assignment (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID UNIQUE REFERENCES orgs(id) ON DELETE CASCADE,
  group_label TEXT NOT NULL CHECK (group_label IN ('A','B')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 视图/物化视图（示例：DAU）
CREATE MATERIALIZED VIEW mv_dau AS
SELECT date_trunc('day', created_at) AS day, count(DISTINCT user_id) AS dau
FROM auth_event
WHERE type='login'
GROUP BY 1
WITH NO DATA;
```

# **2) OpenAPI 3.0 契约（YAML 摘要）**





> 只列出关键端点；你可把这段交给 Cursor 生成 swagger-ui 与类型。

```yaml
openapi: 3.0.3
info:
  title: Chuiyu Menu Platform API
  version: 1.0.0
servers:
  - url: https://api.ai-menu.tech
tags:
  - name: Auth
  - name: RAG
  - name: Menu
  - name: Admin
paths:
  /auth/login:
    post:
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username: { type: string }
                password: { type: string }
      responses:
        '200': { description: OK }

  /rag/upsert:
    post:
      tags: [RAG]
      summary: 批量写入rag文档与向量
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                items:
                  type: array
                  items:
                    type: object
                    required: [doc_type, text]
                    properties:
                      id: { type: string, format: uuid }
                      org_id: { type: string, format: uuid, nullable: true }
                      doc_type: { type: string, enum: [dish, menu, price] }
                      source_id: { type: string, format: uuid, nullable: true }
                      title: { type: string }
                      text: { type: string }
                      meta_json: { type: object }
                      index_version: { type: string }
      responses:
        '200': { description: OK }

  /rag/search:
    post:
      tags: [RAG]
      summary: 相似检索（dish/menu 双索引）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query, topK, mode]
              properties:
                query: { type: string }
                topK: { type: integer, default: 20 }
                mode: { type: string, enum: [dish, menu, hybrid], default: dish }
                filters:
                  type: object
                  properties:
                    region: { type: string }
                    season: { type: string }
                    cost_level: { type: string }
                    method: { type: string }
                    equipment: { type: array, items: { type: string } }
      responses:
        '200':
          description: Results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        doc_id: { type: string, format: uuid }
                        doc_type: { type: string }
                        title: { type: string }
                        text: { type: string }
                        score: { type: number }
                        meta_json: { type: object }

  /menu/generate:
    post:
      tags: [Menu]
      summary: 生成菜单（调用你自定义的 Prompt/策略）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [org_id, store_id]
              properties:
                org_id: { type: string, format: uuid }
                store_id: { type: string, format: uuid }
                constraints: { type: object } # 完全留给你定义
                upload_history_file_id: { type: string, format: uuid, nullable: true }
      responses:
        '200': { description: OK }

  /admin/users:
    get: { tags: [Admin], summary: 列表 }
    post: { tags: [Admin], summary: 新增账号 }
  /admin/users/{id}:
    patch: { tags: [Admin], summary: 修改 }
    delete: { tags: [Admin], summary: 删除 }

  /admin/metrics/summary:
    get:
      tags: [Admin]
      summary: 看板汇总（供 Admin/Metabase 读取或直接连库）
      parameters:
        - in: query
          name: org_id
          schema: { type: string, format: uuid }
        - in: query
          name: store_id
          schema: { type: string, format: uuid }
      responses:
        '200': { description: OK }
```

# **3) Fastify + TypeScript 项目骨架（关键文件）**





**目录结构建议**

```
/app
  /src
    /config/env.ts
    /db/pool.ts
    /routes/auth.ts
    /routes/rag.ts
    /routes/menu.ts
    /routes/admin.ts
    /services/embeddings.ts
    /services/rag.ts
    /services/menu.ts
    /utils/oss.ts
    /utils/hash.ts
    server.ts
  package.json
  tsconfig.json
  Dockerfile
  docker-compose.yml  (见下节)
  nginx.conf          (见下节)
```

**src/config/env.ts**

```ts
export const env = {
  DATABASE_URL: process.env.DATABASE_URL!,
  REDIS_URL: process.env.REDIS_URL || 'redis://redis:6379',
  OSS_REGION: process.env.OSS_REGION!,
  OSS_BUCKET: process.env.OSS_BUCKET!,
  OSS_AK: process.env.OSS_ACCESS_KEY_ID!,
  OSS_SK: process.env.OSS_ACCESS_KEY_SECRET!,
  EMBEDDING_PROVIDER: process.env.EMBEDDING_PROVIDER || 'deepseek',
  EMBEDDING_MODEL: process.env.EMBEDDING_MODEL || 'qwen-emb',
  LLM_PROVIDER: process.env.LLM_PROVIDER || 'deepseek',
  LLM_MODEL: process.env.LLM_MODEL || 'deepseek-chat',
  AB_DEFAULT_MODE: process.env.AB_DEFAULT_MODE || 'dish',
};
```

**src/db/pool.ts**

```ts
import { Pool } from 'pg';
import { env } from '../config/env';

export const pg = new Pool({ connectionString: env.DATABASE_URL });

// 连接后建议执行：SET TIME ZONE 'Asia/Shanghai';
```

**src/services/embeddings.ts**（伪代码接口，实际按你 DeepSeek SDK）

```ts
export async function embed(texts: string[]): Promise<number[][]> {
  // 调用 DeepSeek/阿里可用的 embedding 接口，返回二维数组
  // 注意与 pgvector 维度一致（如1536）
  return []; 
}
```

**src/services/rag.ts（核心：upsert + search）**

```ts
import { pg } from '../db/pool';
import { embed } from './embeddings';

export async function ragUpsert(items: Array<{
  id?: string; org_id?: string|null; doc_type: 'dish'|'menu'|'price';
  source_id?: string|null; title?: string; text: string; meta_json?: any; index_version?: string;
}>) {
  const texts = items.map(i => i.text);
  const vectors = await embed(texts);
  const client = await pg.connect();
  try {
    await client.query('BEGIN');
    for (let i=0;i<items.length;i++){
      const it = items[i];
      const v = vectors[i];
      const { rows } = await client.query(
        `INSERT INTO rag_documents (id, org_id, doc_type, source_id, title, text, meta_json, index_version)
         VALUES (COALESCE($1, uuid_generate_v4()), $2, $3, $4, $5, $6, COALESCE($7,'{}'::jsonb), COALESCE($8,'v1'))
         ON CONFLICT (id) DO UPDATE SET title=EXCLUDED.title, text=EXCLUDED.text, meta_json=EXCLUDED.meta_json, index_version=EXCLUDED.index_version
         RETURNING id`,
        [it.id ?? null, it.org_id ?? null, it.doc_type, it.source_id ?? null, it.title ?? null, it.text, it.meta_json ?? {}, it.index_version ?? 'v1']
      );
      const docId = rows[0].id;
      await client.query(
        `INSERT INTO rag_embeddings (doc_id, embedding, model)
         VALUES ($1, $2, $3)
         ON CONFLICT (doc_id) DO UPDATE SET embedding=EXCLUDED.embedding, model=EXCLUDED.model`,
        [docId, v, process.env.EMBEDDING_MODEL || 'qwen-emb']
      );
    }
    await client.query('COMMIT');
  } catch(e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

export async function ragSearch(params: {
  query: string; topK: number; mode: 'dish'|'menu'|'hybrid';
  filters?: { region?: string; season?: string; cost_level?: string; method?: string; equipment?: string[] }
}) {
  const [vec] = await embed([params.query]);
  const types = params.mode==='hybrid' ? ['dish','menu'] : [params.mode];
  // 结构化过滤拼接（简化示例）
  const docTypeSql = `doc_type = ANY($2)`;
  const sql = `
    SELECT d.id as doc_id, d.doc_type, d.title, d.text, d.meta_json,
           1 - (e.embedding <=> $1::vector) AS score
    FROM rag_embeddings e
    JOIN rag_documents d ON d.id = e.doc_id
    WHERE ${docTypeSql}
    ORDER BY e.embedding <=> $1::vector
    LIMIT $3`;
  const { rows } = await pg.query(sql, [vec, types, params.topK || 20]);
  return rows;
}
```

**src/routes/rag.ts**

```ts
import { FastifyInstance } from 'fastify';
import { ragUpsert, ragSearch } from '../services/rag';

export default async function ragRoutes(f: FastifyInstance){
  f.post('/rag/upsert', async (req, rep) => {
    const body = req.body as any;
    await ragUpsert(body.items || []);
    return { ok: true };
  });
  f.post('/rag/search', async (req, rep) => {
    const body = req.body as any;
    const results = await ragSearch(body);
    return { results };
  });
}
```

**src/routes/menu.ts（你掌控 Prompt/策略，这里只做壳）**

```ts
import { FastifyInstance } from 'fastify';
export default async function menuRoutes(f: FastifyInstance){
  f.post('/menu/generate', async (req, rep) => {
    const { org_id, store_id, constraints, upload_history_file_id } = req.body as any;
    // 1) 若有历史：优先解析/召回；2) 无历史：用自有库召回；3) 你自定义Prompt/规则生成；
    // 4) 写入 menus + generation_event；返回菜单JSON
    return { menu_id: 'TODO', lunch_items_json: [], notes: null };
  });
}
```

**src/routes/admin.ts（账号管理最小集）**

```ts
import { FastifyInstance } from 'fastify';
import { pg } from '../db/pool';
export default async function adminRoutes(f: FastifyInstance){
  f.get('/admin/users', async () => {
    const { rows } = await pg.query(`SELECT id, username, role, is_active, org_id, store_id, created_at FROM users ORDER BY created_at DESC`);
    return rows;
  });
  f.post('/admin/users', async (req) => {
    const { username, password_hash, role, org_id, store_id } = req.body as any;
    const { rows } = await pg.query(
      `INSERT INTO users (username, password_hash, role, org_id, store_id) VALUES ($1,$2,$3,$4,$5) RETURNING id`,
      [username, password_hash, role, org_id || null, store_id || null]
    );
    return { id: rows[0].id };
  });
  f.patch('/admin/users/:id', async (req) => {
    const { id } = req.params as any;
    const { role, is_active, password_hash } = req.body as any;
    await pg.query(
      `UPDATE users SET role=COALESCE($2,role), is_active=COALESCE($3,is_active), password_hash=COALESCE($4,password_hash), updated_at=now() WHERE id=$1`,
      [id, role ?? null, is_active ?? null, password_hash ?? null]
    );
    return { ok: true };
  });
  f.delete('/admin/users/:id', async (req) => {
    const { id } = req.params as any;
    await pg.query(`DELETE FROM users WHERE id=$1`, [id]);
    return { ok: true };
  });
}
```

**src/server.ts**

```ts
import Fastify from 'fastify';
import ragRoutes from './routes/rag';
import menuRoutes from './routes/menu';
import adminRoutes from './routes/admin';

const app = Fastify({ logger: true });
app.register(ragRoutes);
app.register(menuRoutes);
app.register(adminRoutes);

app.get('/health', async () => ({ ok: true }));

app.listen({ host: '0.0.0.0', port: 8080 });
```

# **4) docker-compose.yml（ECS 一键起）**





> Metabase 放容器里；Postgres 用 RDS，不放容器。

```yaml
version: "3.9"
services:
  api:
    build: .
    container_name: chuiyu-api
    env_file: .env
    ports: ["8080:8080"]
    depends_on: [redis]
    restart: always

  redis:
    image: redis:7-alpine
    container_name: chuiyu-redis
    ports: ["6379:6379"]
    restart: always

  nginx:
    image: nginx:alpine
    container_name: chuiyu-nginx
    ports: ["80:80", "443:443"]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt  # 如用LE证书
    depends_on: [api, metabase]
    restart: always

  metabase:
    image: metabase/metabase:latest
    container_name: chuiyu-metabase
    environment:
      - MB_JETTY_PORT=3000
    ports: ["3000:3000"]
    volumes:
      - ./metabase-data:/metabase-data
    restart: always
```

**Nginx 反代示例（nginx.conf）**

```nginx
worker_processes auto;
events { worker_connections 1024; }
http {
  include       /etc/nginx/mime.types;
  sendfile      on;

  map $host $upstream {
    default http://api:8080;
    api.ai-menu.tech http://api:8080;
    bi.ai-menu.tech  http://metabase:3000;
  }

  server {
    listen 80;
    server_name api.ai-menu.tech bi.ai-menu.tech;
    location /.well-known/acme-challenge/ { root /var/www/certbot; }
    location / { return 301 https://$host$request_uri; }
  }

  server {
    listen 443 ssl;
    server_name api.ai-menu.tech bi.ai-menu.tech;

    ssl_certificate     /etc/letsencrypt/live/ai-menu.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ai-menu.tech/privkey.pem;

    location / {
      proxy_pass $upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }
  }
}
```

> 说明：

- > 你可以把 **Admin（Next.js）** 放 Vercel → admin.ai-menu.tech CNAME 到 Vercel；

- > **API 与 Metabase** 通过 ECS 上的 Nginx 暴露：api.ai-menu.tech、bi.ai-menu.tech。

- > 证书：你说已经正常运行，可复用现有证书；若切子域名可增发免费证书。

# **5) Metabase 初始 10 个指标 SQL（直接可用）**



> Metabase 直接连 **RDS**；把下列 SQL 设为卡片视图即可。

1. **DAU（登录）**

```sql
SELECT date_trunc('day', created_at) AS day, COUNT(DISTINCT user_id) AS dau
FROM auth_event
WHERE type = 'login'
GROUP BY 1
ORDER BY 1 DESC
LIMIT 60;
```

2. **菜单生成量（按天）**

   

   ```sql
   SELECT date_trunc('day', created_at) AS day, COUNT(*) AS gen_count
   FROM generation_event
   GROUP BY 1
   ORDER BY 1 DESC
   LIMIT 60;
   ```

   

3. **生成成功率 & P95 时长（按周）**

   ```sql
   WITH w AS (
     SELECT date_trunc('week', created_at) AS wk,
            COUNT(*) FILTER (WHERE status='success')::float / NULLIF(COUNT(*),0) AS success_rate,
            percentile_cont(0.95) WITHIN GROUP (ORDER BY latency_ms) AS p95_latency
     FROM generation_event
     GROUP BY 1
   )
   SELECT * FROM w ORDER BY wk DESC LIMIT 12;
   ```

4. **A/B 对比（成功率 & P95）**

   ```sql
   SELECT ab_group,
          COUNT(*) FILTER (WHERE status='success')::float / NULLIF(COUNT(*),0) AS success_rate,
          percentile_cont(0.95) WITHIN GROUP (ORDER BY latency_ms) AS p95_latency
   FROM generation_event
   GROUP BY ab_group;
   ```

5. **门店活跃榜（近7天生成次数）**

   ```sql
   SELECT s.name AS store, o.name AS org, COUNT(*) AS gen_7d
   FROM generation_event ge
   LEFT JOIN stores s ON ge.store_id=s.id
   LEFT JOIN orgs o ON ge.org_id=o.id
   WHERE ge.created_at >= now() - interval '7 day'
   GROUP BY 1,2
   ORDER BY gen_7d DESC
   LIMIT 50;
   ```

6. **留存（D1/D7）粗略**

   ```sql
   WITH first_use AS (
     SELECT store_id, MIN(created_at) AS first_time
     FROM generation_event
     GROUP BY store_id
   ),
   d1 AS (
     SELECT f.store_id
     FROM first_use f
     JOIN generation_event g
       ON g.store_id=f.store_id
      AND g.created_at >= f.first_time + interval '1 day'
      AND g.created_at <  f.first_time + interval '2 day'
   ),
   d7 AS (
     SELECT f.store_id
     FROM first_use f
     JOIN generation_event g
       ON g.store_id=f.store_id
      AND g.created_at >= f.first_time + interval '7 day'
      AND g.created_at <  f.first_time + interval '8 day'
   )
   SELECT
     (SELECT COUNT(*) FROM first_use) AS cohort,
     (SELECT COUNT(*) FROM d1) AS d1_retained,
     (SELECT COUNT(*) FROM d7) AS d7_retained;
   ```

7. **规则命中率（示例：设备/工艺，多样性）**

   ```sql
   SELECT
     date_trunc('week', created_at) AS wk,
     AVG( (meta_json->>'equipment_ok')::boolean::int ) AS equipment_ok_rate,
     AVG( (meta_json->>'method_diversity_ok')::boolean::int ) AS method_diversity_ok_rate
   FROM generation_event
   GROUP BY 1
   ORDER BY wk DESC;
   ```

8. **历史上传使用率**

   ```sql
   SELECT
     date_trunc('week', created_at) AS wk,
     COUNT(*) FILTER (WHERE meta_json->>'used_history'='true')::float / NULLIF(COUNT(*),0) AS used_history_rate
   FROM generation_event
   GROUP BY 1
   ORDER BY wk DESC;
   ```

9. **模型成本（需你写入 tokens→cost）**

   ```sql
   SELECT
     date_trunc('day', created_at) AS day,
     SUM( (meta_json->>'cost_cny')::numeric ) AS cost_cny
   FROM generation_event
   GROUP BY 1
   ORDER BY 1 DESC;
   ```

10. **失败原因分布**

    ```sql
    SELECT meta_json->>'failure_reason' AS reason, COUNT(*) AS cnt
    FROM generation_event
    WHERE status='failed'
    GROUP BY 1
    ORDER BY cnt DESC;
    ```

    

# **6) 历史 Excel 模板（你给甲方/门店下载用）**





> **午餐为主**，但保留字段，暂可留空。





- sheet 名：lunch

- 列顺序（第一行是表头）：

  

  - 日期（YYYY-MM-DD）
  - 周次（1-52）
  - 餐次（固定写“午”）
  - 菜名
  - 类别（主荤/半荤/素菜/凉菜）
  - 工艺（炒/蒸/炸/煮/炖/烤/煎/烧/拌…）
  - 风味（不辣/微辣/中辣/酸甜/咸鲜/清淡/麻辣…）
  - 设备（蒸箱/烤箱/大锅灶/炸炉…多选可用逗号）
  - 成本等级（低/中/高）——**可空，保留**
  - 备注

  





**导入流程**：上传至 OSS → 创建一条 files 记录 → 后端解析写入 menus 或 rag_documents(doc_type='menu')（取决于“作为历史菜单供参考”还是“直接转结构化记录”）。解析失败项写 meta_json.errors。



------





# **7) A/B 策略（企业维度固定分组）**





- 新增企业时随机 A/B，写入 ab_assignment；同企业永远落同一组。
- 组 A：mode=dish，组 B：mode=menu；/rag/search 依据组别默认 mode。
- 评估两周：看 **成功率、P95、规则命中、人工评分、复用/留存**，胜者成为默认，另一个保留为备用。





------





# **8) 阿里云逐屏操作清单（按你“问 AI 点按钮”的方式写）**





**(1) 创建 RDS PostgreSQL（华北2 北京）**



1. 打开 RDS 控制台 → 购买 → 区域 **华北2(北京)**，类型：**PostgreSQL 14+**。规格先选入门 1C2G/2C4G，存储 20–50GB。

2. 创建完成后：

   

   - 设置**白名单**（先允许 ECS 私网 IP + 你的公网调试 IP）。
   - 重置主用户名/密码，记录连接串。

   

3. 连接后执行：CREATE EXTENSION vector;（可在 DataGrip 或 psql 执行）。

4. 开启**自动备份**，保留 **90 天**。





**(2) 创建 OSS（华北2 北京）**



1. 新建 Bucket：chuiyu-prod，区域 **北京**，读写私有。
2. 开启跨域（CORS）允许你的前端域名（可后加）。
3. 记下 AccessKeyId/Secret 与 Endpoint。





**(3) 日志服务 SLS（华北2 北京）**



1. 新建 Project：chuiyu-logs，Logstore：nginx、app。
2. Nginx 与 API 容器日志输出到文件，由 Filebeat/Logtail 采集（可后续加）。





**(4) ECS 与 Docker**



1. 购买 **ECS**（2C4G 起步即可），系统 Ubuntu 22.04。
2. 安装 Docker & docker-compose。
3. 拉取你的代码仓库（Cursor 生成后 push 到 GitHub/Gitee）。
4. 填 .env（使用 RDS/OSS/DeepSeek 的实际信息）。
5. docker compose up -d 启动。





**(5) 域名与证书**



1. 在域名解析里添加：

   

   - api.ai-menu.tech → 指向 **ECS 公网 IP**
   - bi.ai-menu.tech → 指向 **ECS 公网 IP**
   - admin.ai-menu.tech → 指向 **Vercel CNAME**（若 Admin 上 Vercel）

   

2. 申请/部署证书（如果你已有证书，直接放到 ECS 对应目录并更新 nginx.conf 路径）。





**(6) Metabase 初始化**



1. 打开 https://bi.ai-menu.tech；
2. 初始管理员设置；
3. 添加数据库连接：填写 RDS 连接串；
4. 导入我给你的 10 个 SQL，拼装你的大屏。





**(7) 告警**



- 先用 **邮箱** 告警：将监控系统（SLS 或简单 cron job）发送到 lyratng@163.com。
- 后续可加企业微信机器人。





------





# **9) 兜底策略（失败回退）**





- 若 /menu/generate 失败或返回不满足“数量硬约束”，执行**规则驱动兜底**：

  

  - 从 dishes 中按设备/工艺/辣度/成本的规则**贪心选取**；
  - 保证每天 **(主荤/半荤/素/凉)** 数量达标；
  - 不重复主要原料；
  - 标识 source_type='internal_library'，meta_json.fallback=true。

  





------

# **10) .env 模板（放到 ECS）**

```
DATABASE_URL=postgres://USER:PASSWORD@rds-xxxx.pg.rds.aliyuncs.com:5432/app
REDIS_URL=redis://redis:6379

OSS_REGION=cn-beijing
OSS_BUCKET=chuiyu-prod
OSS_ACCESS_KEY_ID=xxxx
OSS_ACCESS_KEY_SECRET=xxxx

EMBEDDING_PROVIDER=deepseek
EMBEDDING_MODEL=qwen-emb
LLM_PROVIDER=deepseek
LLM_MODEL=deepseek-chat

AB_DEFAULT_MODE=dish
ALERT_EMAIL=lyratng@163.com
```

