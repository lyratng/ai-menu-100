# 菜单生成逻辑分析报告

> **生成时间**: 2025-11-04  
> **目的**: 对比当前实现与PRD要求，找出差异并提供改进方向

---

## 一、当前实现 vs PRD要求对比

### 1.1 生成天数

| 对比项 | PRD要求 | 当前实现 | 差异原因 |
|--------|---------|----------|----------|
| 生成天数 | **5天**（周一~周五） | **1天**（仅周一） | 第285行代码注释：`🔥 临时修改：只生成1天菜单，用于测试` |
| AI输出格式 | 5个key（monday~friday） | 1个key（monday） | Prompt只要求monday |

**代码位置**: `backend/src/services/menu.ts` 第285-301行

```typescript
// 当前实现（简化版）
const systemPrompt = `你是一位经验丰富的厨师长。请为团餐食堂生成一天的午餐菜谱。`;
// 输出格式只有: { "monday": [...] }
```

**PRD要求**（第917-924行）：
```json
{
  "monday": [...],
  "tuesday": [...],
  "wednesday": [...],
  "thursday": [...],
  "friday": [...]
}
```

---

### 1.2 菜品检索逻辑

| 对比项 | PRD要求 | 当前实现 | 差异 |
|--------|---------|----------|------|
| 菜品来源 | 384种细分标签检索 | 随机抽取 | ❌ 未实现细分检索 |
| 每种标签菜品数 | 10道/标签 | - | ❌ 未实现 |
| 检索总数 | 3,840道（理论） | 15道 | ❌ 严重不足 |
| 历史菜占比 | 按比例混合 | 未区分 | ❌ 未实现 |

**当前实现**（第246-276行）：
```typescript
async function fetchAllAvailableDishes(storeId: string, historyRatio: number): Promise<any[]> {
  // 直接随机查询所有菜品
  SELECT * FROM dishes_common WHERE is_active = TRUE ORDER BY RANDOM()
  // 只返回所有可用菜品，未按标签分类
}
```

**PRD要求**（第874-886行）：
```
前置工作：
1. 计算需要的菜品总数 = (热菜+凉菜) × 5天
2. 计算历史菜数 = 总数 × 历史占比
3. 按384种细分标签（4类型 × 8食材 × 12刀工）检索
   - 每种标签检索10道菜（通用库占比）
   - 每种标签检索10道菜（历史库占比）
```

**384种细分标签计算**：
```
4种菜品类型: 主荤、半荤、素菜、凉菜
× 8种食材: 肉/禽/鱼/蛋/豆/菌/筋/蔬
× 12种刀工: 片/丁/粒/米/末/茸/丝/条/段/块/球/花刀
= 384种组合
```

---

### 1.3 AI Prompt完整性

| 规则类别 | PRD要求 | 当前实现 | 是否实现 |
|----------|---------|----------|----------|
| **基础要求** | 菜名、菜品数量 | ✅ 有 | ✅ 部分 |
| **菜名使用规则** | 必须逐字匹配菜品库 | ✅ 有 | ✅ 已实现 |
| **设备可实现性** | 8种烹饪方式选择 | ❌ 无 | ❌ 未实现 |
| **成本控制** | 避免重复高成本食材 | ❌ 无 | ❌ 未实现 |
| **食材多样性** | 主要食材不重复 | ❌ 无 | ❌ 未实现 |
| **原材料多样性** | 8大类≥4/5/6种 | ❌ 无 | ❌ 未实现 |
| **辣味菜数量** | 0/15%/30% | ❌ 无 | ❌ 未实现 |
| **刀工多样性** | 人员紧张≤10%复杂刀工 | ❌ 无 | ❌ 未实现 |
| **调味品多样性** | 每餐≥5种风味 | ❌ 无 | ❌ 未实现 |
| **烹饪方式多样性** | 至少6种/周 | ❌ 无 | ❌ 未实现 |
| **口感多样性** | 不超过2道勾芡菜 | ❌ 无 | ❌ 未实现 |

**当前Prompt**（第286-311行）：
```typescript
const systemPrompt = `你是一位经验丰富的厨师长。请为团餐食堂生成一天的午餐菜谱。
【重要】菜名规则：必须严格使用提供的菜品来源中的菜名，不得修改。
【输出要求】：严格按照JSON格式输出`;

const userPrompt = `请从以下菜品中选10道菜，生成一天的午餐菜谱。
【菜品来源】：拍黄瓜、手撕包菜、...（15道菜）`;
```

**PRD完整Prompt**（第889-926行）：包含9大约束规则 + 详细输出格式。

---

### 1.4 菜品数量问题

| 数据库 | 当前状态 | PRD要求 | 是否充足 |
|--------|----------|---------|----------|
| **通用菜库** | 20道菜 | 5,000-10,000道 | ❌ 严重不足 |
| **专属菜库** | 0道菜 | 上传1-8份历史菜单 | ❌ 为空 |
| **理论需求** | 3,840道（384×10） | 实际20道 | ❌ 仅0.5% |

**为什么只生成周一的菜？**
1. **Prompt限制**：代码第286行只要求生成"一天的午餐菜谱"
2. **输出格式**：只定义了`{"monday": [...]}`，没有tuesday-friday
3. **菜品不足**：15道菜无法支撑5天×10道/天=50道菜的需求

**为什么菜品数量少？**
1. **Prompt限制**：第304行`dishes.slice(0, 15)`只取前15道菜
2. **通用库不足**：只有20道菜，无法满足384种标签检索
3. **随机性差**：每次生成只能从这15道菜中选择

---

## 二、改进所需的关键步骤

### 步骤1：扩充通用菜品库（最优先）

**目标**：从20道 → 至少200道（短期），最终5,000-10,000道

**需要的完整8个标签**（符合PRD第52-68行）：

根据PRD，每道菜品有**8个标签**：

| 序号 | 标签名 | 数据库字段 | 类型 | 是否必填 | 说明 |
|------|--------|-----------|------|----------|------|
| 1 | 菜品类型 | `dish_type` | TEXT | ✅ 必填 | 午餐4选1：热菜主荤/热菜半荤/热菜素菜/凉菜 |
| 2 | 食材特征 | `ingredient_tags` | TEXT[] | ✅ 必填（热菜） | 8大类：肉/禽/鱼/蛋/豆/菌/筋/蔬 |
| 3 | 刀工 | `knife_skill` | TEXT | ✅ 必填 | 12种：片/丁/粒/米/末/茸/丝/条/段/块/球/花刀 |
| 4 | 菜系 | `cuisine` | TEXT | ⚪ 可选 | 34个省市菜系或家常菜，可NULL |
| 5 | 烹饪方式 | `cook_method8` | TEXT | ✅ 必填 | **必须映射到8大类**：炒/熘/蒸/烧/烤/炖/煎/烹 |
| 6 | 口味 | `flavor` | TEXT | ✅ 必填 | 咸鲜/麻辣/酸甜/清淡等，自由填写 |
| 7a | 主料 | `main_ingredients` | TEXT[] | ⚪ 可选 | 具体到牛肉、牛腩、翅中等 |
| 7b | 辅料 | `sub_ingredients` | TEXT[] | ⚪ 可选 | 葱姜蒜、调料等 |
| 8 | 季节 | `seasons` | TEXT[] | ⚪ 可选 | 春/夏/秋/冬，时令菜填写 |

**完整SQL结构**：
```sql
INSERT INTO dishes_common (
  -- 必填字段（5个）
  dish_name,           -- 菜名
  dish_type,           -- 1. 菜品类型（4选1）
  ingredient_tags,     -- 2. 食材特征（8大类数组）
  knife_skill,         -- 3. 刀工（12种）
  cook_method8,        -- 5. 烹饪方式（8大类）
  flavor,              -- 6. 口味
  
  -- 可选字段（3个）
  cuisine,             -- 4. 菜系
  main_ingredients,    -- 7a. 主料
  sub_ingredients,     -- 7b. 辅料
  seasons              -- 8. 季节
) VALUES (
  '红烧排骨',
  '热菜主荤',
  ARRAY['肉'],
  '块',
  '烧',
  '咸鲜',
  '川菜',
  ARRAY['猪排'],
  ARRAY['酱油', '冰糖'],
  ARRAY[]
);
```

**⚠️ 关键注意**：
- **烹饪方式**虽然实际有几十种（炸、卤、煮、拌等），但**必须映射到8大类之一**
- `拌`/`凉拌`等不属于8大类，用于凉菜
- `炸`等复杂烹饪方式需按主要工艺归入8大类（如炸→炒或烤）

### 步骤2：修改生成逻辑代码

**需要修改的文件**：`backend/src/services/menu.ts`

**主要改动**：
1. **第285行**：改为生成5天菜单
2. **第246-276行**：实现384种细分标签检索
3. **第281-314行**：补充完整的9大约束规则到Prompt
4. **第304行**：移除`slice(0, 15)`限制，使用所有检索到的菜品

### 步骤3：添加历史菜单上传功能

**当前状态**：前端有上传界面（`frontend/app/register/page.tsx`），但后端解析逻辑未完成

**需要**：
1. 实现Excel解析（BullMQ + Redis异步队列）
2. 调用AI解析菜品标签
3. 写入`dishes_store`表

---

## 三、立即可行的改进（不改代码）

### ✅ 可以先做的事：扩充菜品库

即使不改代码，扩充菜品库也能显著提升生成质量。

**操作方法**：见下一节《如何添加菜品到数据库》

---

## 四、如何添加菜品到数据库

### 方法1：SQL批量导入（推荐用于大量菜品）

#### 步骤1：准备CSV文件

创建文件：`/Users/apple/ai-menu-100/data/dishes_import.csv`

```csv
dish_name,dish_type,ingredient_tags,knife_skill,cook_method8,flavor,cuisine
红烧排骨,热菜主荤,"{肉}",块,烧,咸鲜,川菜
清蒸鲈鱼,热菜主荤,"{鱼}",整条,蒸,咸鲜,粤菜
西红柿炒蛋,热菜半荤,"{蛋,蔬}",块,炒,酸甜,家常菜
清炒油菜,热菜素菜,"{蔬}",段,炒,清淡,家常菜
凉拌木耳,凉菜,"{菌}",片,拌,咸鲜,家常菜
```

**注意**：
- `ingredient_tags`用花括号`{}`包裹，用逗号分隔
- `dish_type`必须是4选1：热菜主荤/热菜半荤/热菜素菜/凉菜
- `cook_method8`必须是8选1：炒/熘/蒸/烧/烤/炖/煎/烹

#### 步骤2：导入到数据库

```bash
# 进入项目目录
cd /Users/apple/ai-menu-100

# 使用psql导入（完整8个标签版本）
psql ai_menu -c "\COPY dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine, main_ingredients, sub_ingredients, seasons) FROM '/Users/apple/ai-menu-100/data/dishes_import.csv' WITH (FORMAT csv, HEADER true);"

# 或者只导入必填字段（简化版）
psql ai_menu -c "\COPY dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) FROM '/Users/apple/ai-menu-100/data/dishes_import.csv' WITH (FORMAT csv, HEADER true);"
```

#### 步骤3：验证导入结果

```bash
psql ai_menu -c "SELECT dish_type, COUNT(*) FROM dishes_common WHERE is_active = TRUE GROUP BY dish_type;"
```

---

### 方法2：SQL脚本逐条插入（适合少量菜品）

创建文件：`/Users/apple/ai-menu-100/scripts/add-dishes.sql`

```sql
-- 批量插入菜品示例

-- 主荤类（肉）
INSERT INTO dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) VALUES
('红烧排骨', '热菜主荤', ARRAY['肉'], '块', '烧', '咸鲜', '川菜'),
('糖醋排骨', '热菜主荤', ARRAY['肉'], '块', '炸', '酸甜', '川菜'),
('京酱肉丝', '热菜主荤', ARRAY['肉'], '丝', '炒', '咸鲜', '京菜'),
('东坡肉', '热菜主荤', ARRAY['肉'], '块', '烧', '咸甜', '浙菜'),
('梅菜扣肉', '热菜主荤', ARRAY['肉'], '片', '蒸', '咸鲜', '粤菜');

-- 主荤类（禽）
INSERT INTO dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) VALUES
('口水鸡', '热菜主荤', ARRAY['禽'], '块', '煮', '麻辣', '川菜'),
('辣子鸡', '热菜主荤', ARRAY['禽'], '丁', '炒', '麻辣', '川菜'),
('三杯鸡', '热菜主荤', ARRAY['禽'], '块', '烧', '咸鲜', '赣菜'),
('白切鸡', '热菜主荤', ARRAY['禽'], '块', '煮', '清淡', '粤菜'),
('大盘鸡', '热菜主荤', ARRAY['禽'], '块', '烧', '麻辣', '新疆菜');

-- 主荤类（鱼）
INSERT INTO dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) VALUES
('清蒸桂鱼', '热菜主荤', ARRAY['鱼'], '整条', '蒸', '咸鲜', '粤菜'),
('红烧鲤鱼', '热菜主荤', ARRAY['鱼'], '整条', '烧', '咸鲜', '鲁菜'),
('酸菜鱼', '热菜主荤', ARRAY['鱼'], '片', '煮', '酸辣', '川菜'),
('糖醋鱼', '热菜主荤', ARRAY['鱼'], '整条', '炸', '酸甜', '浙菜'),
('松鼠桂鱼', '热菜主荤', ARRAY['鱼'], '花刀', '炸', '酸甜', '苏菜');

-- 半荤类
INSERT INTO dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) VALUES
('肉沫豆腐', '热菜半荤', ARRAY['豆','肉'], '末', '烧', '咸鲜', '家常菜'),
('肉末茄子', '热菜半荤', ARRAY['蔬','肉'], '末', '烧', '咸鲜', '家常菜'),
('蚂蚁上树', '热菜半荤', ARRAY['豆','肉'], '末', '炒', '咸鲜', '川菜'),
('木须肉', '热菜半荤', ARRAY['蛋','肉','菌'], '片', '炒', '咸鲜', '家常菜'),
('番茄炒蛋', '热菜半荤', ARRAY['蛋','蔬'], '块', '炒', '酸甜', '家常菜');

-- 素菜类
INSERT INTO dishes_common (dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) VALUES
('干锅菜花', '热菜素菜', ARRAY['蔬'], '朵', '炒', '咸鲜', '家常菜'),
('地三鲜', '热菜素菜', ARRAY['蔬'], '块', '炒', '咸鲜', '东北菜'),
('酸辣土豆丝', '热菜素菜', ARRAY['蔬'], '丝', '炒', '酸辣', '家常菜'),
('炒豆角', '热菜素菜', ARRAY['蔬'], '段', '炒', '咸鲜', '家常菜'),
('蒜蓉油麦菜', '热菜素菜', ARRAY['蔬'], '段', '炒', '蒜香', '家常菜');

-- 凉菜类
INSERT INTO dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) VALUES
('皮蛋豆腐', '凉菜', ARRAY['豆','蛋'], '块', '拌', '咸鲜', '家常菜'),
('凉拌豆芽', '凉菜', ARRAY['蔬'], '根', '拌', '咸鲜', '家常菜'),
('老虎菜', '凉菜', ARRAY['蔬'], '丝', '拌', '咸鲜', '东北菜'),
('酸辣藕片', '凉菜', ARRAY['蔬'], '片', '拌', '酸辣', '家常菜'),
('蒜泥白肉', '凉菜', ARRAY['肉'], '片', '拌', '蒜香', '川菜');

-- 验证插入结果
SELECT dish_type, COUNT(*) as count 
FROM dishes_common 
WHERE is_active = TRUE 
GROUP BY dish_type 
ORDER BY dish_type;

SELECT COUNT(*) as total_dishes FROM dishes_common WHERE is_active = TRUE;
```

执行导入：
```bash
cd /Users/apple/ai-menu-100
psql ai_menu -f scripts/add-dishes.sql
```

---

### 方法3：使用Excel模板批量导入（最友好）

#### 步骤1：创建Excel模板

下载或创建Excel文件：`菜品导入模板.xlsx`

**Sheet1: 菜品清单**

| 菜名 | 菜品类型 | 食材特征 | 刀工 | 烹饪方式 | 口味 | 菜系 | 主料 | 辅料 | 季节 |
|------|----------|----------|------|----------|------|------|------|------|------|
| 红烧排骨 | 热菜主荤 | 肉 | 块 | 烧 | 咸鲜 | 川菜 | 猪排 | 葱姜 | 全年 |
| 清蒸鲈鱼 | 热菜主荤 | 鱼 | 整条 | 蒸 | 咸鲜 | 粤菜 | 鲈鱼 | 葱姜 | 全年 |
| 番茄炒蛋 | 热菜半荤 | 蛋,蔬 | 块 | 炒 | 酸甜 | 家常菜 | 鸡蛋,番茄 | 葱 | 全年 |

**注意**：
- **食材特征**列：多个用逗号分隔（如：`肉,蔬`）
- **菜品类型**必须严格写成：`热菜主荤`/`热菜半荤`/`热菜素菜`/`凉菜`
- **烹饪方式**必须是8种之一：`炒`/`熘`/`蒸`/`烧`/`烤`/`炖`/`煎`/`烹`

#### 步骤2：转换Excel为SQL

创建Python脚本：`/Users/apple/ai-menu-100/scripts/excel_to_sql.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Excel菜品数据转SQL脚本
用法: python3 excel_to_sql.py 菜品导入模板.xlsx
"""

import pandas as pd
import sys

def excel_to_sql(excel_file, output_sql='insert_dishes.sql'):
    # 读取Excel
    df = pd.read_excel(excel_file)
    
    # 生成SQL
    sql_statements = []
    sql_statements.append("-- 自动生成的菜品插入SQL\n")
    sql_statements.append("-- 生成时间: " + pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S') + "\n\n")
    
    for _, row in df.iterrows():
        # 处理食材特征（转为数组）
        ingredients = row['食材特征'].split(',') if pd.notna(row['食材特征']) else []
        ingredient_array = "ARRAY['" + "','".join(ingredients) + "']" if ingredients else "ARRAY[]::TEXT[]"
        
        # 构建INSERT语句
        sql = f"""INSERT INTO dishes_common (dish_name, dish_type, ingredient_tags, knife_skill, cook_method8, flavor, cuisine) VALUES
('{row['菜名']}', '{row['菜品类型']}', {ingredient_array}, '{row['刀工']}', '{row['烹饪方式']}', '{row['口味']}', '{row['菜系']}');
"""
        sql_statements.append(sql)
    
    # 写入文件
    with open(output_sql, 'w', encoding='utf-8') as f:
        f.writelines(sql_statements)
    
    print(f"✅ 成功生成 {output_sql}")
    print(f"📊 共 {len(df)} 道菜品")
    print(f"\n执行导入命令：")
    print(f"psql ai_menu -f {output_sql}")

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("用法: python3 excel_to_sql.py <Excel文件路径>")
        sys.exit(1)
    
    excel_to_sql(sys.argv[1])
```

执行：
```bash
cd /Users/apple/ai-menu-100/scripts
python3 excel_to_sql.py ../data/菜品导入模板.xlsx
psql ai_menu -f insert_dishes.sql
```

---

## 五、快速测试新增菜品

添加菜品后，验证是否生效：

```bash
# 1. 查看总数
psql ai_menu -c "SELECT COUNT(*) as total FROM dishes_common WHERE is_active = TRUE;"

# 2. 按类型统计
psql ai_menu -c "SELECT dish_type, COUNT(*) FROM dishes_common WHERE is_active = TRUE GROUP BY dish_type;"

# 3. 查看新增的菜
psql ai_menu -c "SELECT dish_name, dish_type, ingredient_tags, cook_method8 FROM dishes_common ORDER BY created_at DESC LIMIT 20;"

# 4. 检查各标签覆盖度
psql ai_menu -c "SELECT cook_method8, COUNT(*) FROM dishes_common WHERE is_active = TRUE GROUP BY cook_method8;"
```

---

## 六、完整8个标签使用指南

### 6.1 标签概览表

| 序号 | 标签名 | 数据库字段 | 数据类型 | 必填 | 可选值/格式 |
|------|--------|-----------|---------|------|------------|
| 1 | 菜品类型 | `dish_type` | TEXT | ✅ | `热菜主荤`/`热菜半荤`/`热菜素菜`/`凉菜` |
| 2 | 食材特征 | `ingredient_tags` | TEXT[] | ✅ | `ARRAY['肉','禽','鱼','蛋','豆','菌','筋','蔬']`任意组合 |
| 3 | 刀工 | `knife_skill` | TEXT | ✅ | `片`/`丁`/`粒`/`米`/`末`/`茸`/`丝`/`条`/`段`/`块`/`球`/`花刀` |
| 4 | 菜系 | `cuisine` | TEXT | ⚪ | `川菜`/`粤菜`/`家常菜`等，或NULL |
| 5 | 烹饪方式 | `cook_method8` | TEXT | ✅ | **必须是8选1**：`炒`/`熘`/`蒸`/`烧`/`烤`/`炖`/`煎`/`烹` |
| 6 | 口味 | `flavor` | TEXT | ✅ | 自由文本，如`咸鲜`/`麻辣`/`酸甜` |
| 7a | 主料 | `main_ingredients` | TEXT[] | ⚪ | `ARRAY['猪排','牛肉']`或`ARRAY[]` |
| 7b | 辅料 | `sub_ingredients` | TEXT[] | ⚪ | `ARRAY['酱油','葱姜']`或`ARRAY[]` |
| 8 | 季节 | `seasons` | TEXT[] | ⚪ | `ARRAY['春','夏']`或`ARRAY[]` |

### 6.2 烹饪方式映射表（重要！）

**⚠️ 关键规则**：虽然实际烹饪方式有几十种，但数据库中的`cook_method8`字段**必须映射到8大类之一**。

| 8大类 | 包含的实际烹饪方式 | 映射规则 | 示例菜品 |
|-------|-------------------|---------|---------|
| **炒** | 炒、煸、爆、干煸、溜锅、急火快炒 | 快速高温翻炒的都归这类 | 青椒肉丝、手撕包菜 |
| **熘** | 熘、溜（溜肉段） | 明确含"熘"字的 | 糖醋里脊、锅包肉 |
| **蒸** | 蒸、汆、灼、白灼 | 水汽加热的 | 清蒸鲈鱼、白灼虾 |
| **烧** | 烧、烩、浇汁、烹汁、焖、煨 | 加汤汁炖煮的 | 红烧肉、黄焖鸡 |
| **烤** | 烤、焗、扒、熏 | 干热烘烤的 | 烤鸭、叉烧 |
| **炖** | 炖、煲、汤、煮（炖煮） | 长时间文火的 | 炖排骨、老鸭汤 |
| **煎** | 煎、煎焖 | 少油煎制的 | 煎饺、煎鱼 |
| **烹** | 烹（明确含"烹"字） | 快速爆香后加汁的 | 干烹仔鸡 |

**不属于8大类的烹饪方式处理**：
- `拌` / `凉拌` → 凉菜专用，**仍使用`拌`**（不属于8大类，但允许）
- `炸` → 按照炸后的工艺归类：
  - 爆炸、油炸快炒 → `炒`
  - 炸后浇汁 → `烧`
  - 干炸外脆 → `烤`
- `卤` → `炖`（长时间卤制）
- `煮` → `蒸`（水煮）或`炖`（煮炖）
- `酿` / `浸` → 按主要工艺归类

**实际例子**：
```sql
-- 正确示例
('糖醋里脊', '热菜主荤', ..., '熘', ...)  -- ✅ 虽然实际是炸+浇汁，但主要特征是"熘"
('地三鲜', '热菜素菜', ..., '炸', ...)    -- ⚠️ 错误！应该改为'炒'或'烧'
('拍黄瓜', '凉菜', ..., '拌', ...)        -- ✅ 凉菜可以用'拌'
```

### 6.3 数据质量检查清单

**添加菜品前必须检查**：

#### 必填字段检查
- [ ] **dish_type** 只能是4个值之一（热菜主荤/热菜半荤/热菜素菜/凉菜）
- [ ] **ingredient_tags** 只包含8大类（肉/禽/鱼/蛋/豆/菌/筋/蔬），格式为`ARRAY[]`
- [ ] **knife_skill** 在12种刀工中（片/丁/粒/米/末/茸/丝/条/段/块/球/花刀）
- [ ] **cook_method8** 只能是8种之一（炒/熘/蒸/烧/烤/炖/煎/烹）或凉菜的`拌`
- [ ] **flavor** 已填写（咸鲜/麻辣/酸甜等）

#### 可选字段检查
- [ ] **cuisine** 可以是NULL，或填写具体菜系
- [ ] **main_ingredients** 如果填写，必须是`ARRAY[]`格式
- [ ] **sub_ingredients** 如果填写，必须是`ARRAY[]`格式
- [ ] **seasons** 只能包含`春`/`夏`/`秋`/`冬`，或为空数组

#### 数量检查
- [ ] 每种`dish_type`至少有10道菜
- [ ] 每种`cook_method8`至少有5道菜
- [ ] 每种`ingredient_tags`组合至少有3道菜

### 6.4 完整SQL模板

**模板1：包含全部8个标签**
```sql
INSERT INTO dishes_common (
  dish_name, dish_type, ingredient_tags, knife_skill, 
  cook_method8, flavor, cuisine, 
  main_ingredients, sub_ingredients, seasons
) VALUES (
  '菜名',
  '热菜主荤',              -- 1. 菜品类型（4选1）
  ARRAY['肉', '蔬'],      -- 2. 食材特征（8大类数组）
  '片',                   -- 3. 刀工（12选1）
  '炒',                   -- 5. 烹饪方式（8选1）
  '咸鲜',                 -- 6. 口味
  '川菜',                 -- 4. 菜系（可NULL）
  ARRAY['猪肉', '青椒'],  -- 7a. 主料（可空数组）
  ARRAY['酱油', '葱姜'],  -- 7b. 辅料（可空数组）
  ARRAY[]                 -- 8. 季节（可空数组）
);
```

**模板2：只包含必填字段**
```sql
INSERT INTO dishes_common (
  dish_name, dish_type, ingredient_tags, knife_skill, 
  cook_method8, flavor
) VALUES (
  '菜名', '热菜主荤', ARRAY['肉'], '片', '炒', '咸鲜'
);
```

---

## 七、推荐的菜品库构建路线图

### 阶段1：基础库（100道菜）

**目标**：支持基本菜单生成

- 主荤：40道（肉20 + 禽10 + 鱼10）
- 半荤：20道
- 素菜：30道
- 凉菜：10道

### 阶段2：扩展库（500道菜）

**目标**：支持多样化菜单

- 覆盖8种烹饪方式各50道
- 覆盖12种刀工各30道
- 覆盖8种食材各60道

### 阶段3：完整库（5,000+道菜）

**目标**：接近PRD要求，支持384种标签检索

- 每种标签组合至少10道菜
- 支持季节性菜品
- 支持地方特色菜

---

## 八、常见问题

### Q1: 为什么添加了菜品，生成的菜单还是只有几道？

**A**: 检查以下几点：
1. 后端代码第304行是否还是`slice(0, 15)`？需要去掉这个限制
2. Prompt是否还是只生成1天？需要改为5天
3. 菜品的`is_active`字段是否为`TRUE`？

### Q2: 可以直接修改现有菜品的标签吗？

**A**: 可以！使用UPDATE语句：
```sql
UPDATE dishes_common 
SET ingredient_tags = ARRAY['肉', '蔬'], knife_skill = '丝' 
WHERE dish_name = '青椒肉丝';
```

### Q3: 如何删除错误的菜品？

**A**: 使用软删除（推荐）：
```sql
UPDATE dishes_common SET is_active = FALSE WHERE dish_name = '错误的菜名';
```

或物理删除：
```sql
DELETE FROM dishes_common WHERE dish_name = '错误的菜名';
```

---

## 九、总结

### 当前限制因素（按优先级）

1. **🔴 代码限制**：只生成1天菜单（第285行）
2. **🔴 菜品不足**：20道菜 vs 理论需求3,840道
3. **🟡 检索逻辑**：未实现384种细分标签
4. **🟡 约束规则**：Prompt缺少9大约束

### 优先改进顺序

**短期（立即可做）**：
1. ✅ 扩充菜品库到100道（使用本文档方法）
2. 修改代码生成5天菜单
3. 移除`slice(0, 15)`限制

**中期（1周内）**：
1. 扩充菜品库到500道
2. 实现384种细分标签检索
3. 完善Prompt约束规则

**长期（1个月内）**：
1. 扩充菜品库到5,000道
2. 实现历史菜单上传功能
3. 优化生成质量和性能

---

**文档版本**: v1.0  
**最后更新**: 2025-11-04  
**维护者**: AI Assistant

