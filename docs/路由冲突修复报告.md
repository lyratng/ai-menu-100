# è·¯ç”±å†²çªä¿®å¤æŠ¥å‘Š

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Method 'POST' already declared for route '/api/menu/upload'
```

**åŸå› **ï¼š
- `backend/src/routes/menu.ts` ä¸­å·²æœ‰ `/upload` è·¯ç”±ï¼ˆå®Œæ•´è·¯å¾„ä¸º `/api/menu/upload`ï¼‰
- æ–°åˆ›å»ºçš„ `backend/src/routes/upload.ts` ä¸­åˆå®šä¹‰äº† `/api/menu/upload` è·¯ç”±
- å¯¼è‡´è·¯ç”±é‡å¤æ³¨å†Œ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ é™¤é‡å¤æ–‡ä»¶
- âŒ åˆ é™¤ï¼š`backend/src/routes/upload.ts`

### 2. æ›´æ–°ç°æœ‰æ–‡ä»¶

#### `backend/src/services/menuUpload.ts`
**æ”¹åŠ¨**ï¼šæ•´åˆæ–°çš„ä¸Šä¼ é€»è¾‘

**æ–°åŠŸèƒ½**ï¼š
- âœ… ä½¿ç”¨ `parseMenuExcel` ä» `excelParser.ts` è§£æExcel
- âœ… ä½¿ç”¨ BullMQ é˜Ÿåˆ—ç³»ç»Ÿ
- âœ… å°†æ•°æ®ä¿å­˜åˆ° `menus` è¡¨ï¼ˆè€Œä¸æ˜¯æ—§çš„ `history_uploads` è¡¨ï¼‰
- âœ… è°ƒç”¨ `addMenuParseJob` æ¨é€å¼‚æ­¥ä»»åŠ¡
- âœ… è¿”å› `menu_id` å’Œ `job_id`

**ä¸»è¦å‡½æ•°**ï¼š
```typescript
export async function uploadHistoryMenu(
  file: Buffer,
  fileName: string,
  storeId: string,
  userId: string,
  mealType: 'lunch' | 'dinner'
): Promise<{ 
  menu_id: string; 
  job_id: string; 
  status: string; 
  days: number 
}>
```

---

#### `backend/src/routes/menu.ts`
**æ”¹åŠ¨**ï¼šæ›´æ–° retry è·¯ç”±

**å˜åŒ–**ï¼š
- å‚æ•°ä» `upload_id` æ”¹ä¸º `menu_id`
- ä¼ é€’ `storeId` åˆ° `retryParsing` å‡½æ•°
- è¿”å› `job_id`

---

#### `backend/src/server.ts`
**æ”¹åŠ¨**ï¼šç§»é™¤é‡å¤çš„è·¯ç”±æ³¨å†Œ

**åˆ é™¤**ï¼š
```typescript
import uploadRoutes from './routes/upload';
fastify.register(uploadRoutes);
```

**ä¿ç•™**ï¼š
```typescript
import './queue/menuParseQueue';  // Workerè‡ªåŠ¨å¯åŠ¨
```

---

## ğŸ“‹ æ–‡ä»¶æ¸…å•

### åˆ é™¤çš„æ–‡ä»¶
- âŒ `backend/src/routes/upload.ts` - é‡å¤çš„ä¸Šä¼ è·¯ç”±

### ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `backend/src/services/menuUpload.ts` - æ•´åˆæ–°é€»è¾‘
2. âœ… `backend/src/routes/menu.ts` - æ›´æ–°retryè·¯ç”±
3. âœ… `backend/src/server.ts` - ç§»é™¤é‡å¤æ³¨å†Œ

### ä¿ç•™çš„æ–°æ–‡ä»¶
1. âœ… `backend/src/utils/excelParser.ts` - Excelè§£æå·¥å…·
2. âœ… `backend/src/queue/connection.ts` - Redisè¿æ¥
3. âœ… `backend/src/queue/menuParseQueue.ts` - é˜Ÿåˆ—å’ŒWorker
4. âœ… `backend/src/services/menuParse.ts` - AIè§£ææœåŠ¡

---

## ğŸ§ª éªŒè¯

### 1. åç«¯å¯åŠ¨æˆåŠŸ
```bash
cd /Users/apple/ai-menu-100/backend
pnpm dev
```

**åº”è¯¥çœ‹åˆ°**ï¼š
```
âœ… Redisè¿æ¥æˆåŠŸ
ğŸš€ èœå•è§£æWorkerå·²å¯åŠ¨
ğŸ¯ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ: http://0.0.0.0:8080
```

**ä¸åº”è¯¥çœ‹åˆ°**ï¼š
```
âŒ Method 'POST' already declared for route '/api/menu/upload'
```

---

### 2. APIç«¯ç‚¹å¯ç”¨

**ä¸Šä¼ ç«¯ç‚¹**ï¼š
```bash
POST http://localhost:8080/api/menu/upload
```

**å…¶ä»–ç«¯ç‚¹**ï¼š
```bash
GET  http://localhost:8080/api/menu/upload/history
POST http://localhost:8080/api/menu/upload/retry
GET  http://localhost:8080/api/menu/upload/queue-status
```

---

## ğŸ¯ å½“å‰çŠ¶æ€

### åç«¯
- âœ… æœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆç«¯å£8080ï¼‰
- âœ… Redisè¿æ¥æˆåŠŸ
- âœ… Workerå·²å¯åŠ¨
- âœ… è·¯ç”±å†²çªå·²è§£å†³

### å‰ç«¯
- âœ… æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å·²å®ç°
- â¸ï¸ è§£æçŠ¶æ€æ å¾…å®ç°

---

## ğŸ“ ä¸‹ä¸€æ­¥

### 1. å¯åŠ¨Redisï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰
```bash
brew install redis
brew services start redis
redis-cli ping  # åº”è¯¥è¿”å›ï¼šPONG
```

### 2. å‡†å¤‡æµ‹è¯•Excelæ–‡ä»¶
æ ¼å¼è¦æ±‚ï¼š
| å‘¨ä¸€ | å‘¨äºŒ | å‘¨ä¸‰ | å‘¨å›› | å‘¨äº” |
|------|------|------|------|------|
| çº¢çƒ§è‚‰ | å®«ä¿é¸¡ä¸ | é±¼é¦™è‚‰ä¸ | ç³–é†‹æ’éª¨ | å›é”…è‚‰ |
| å¯ä¹é¸¡ç¿… | é¦™è‡çƒ§é¸¡ | çº¢çƒ§å¸¦é±¼ | é…¸èœé±¼ | æ°´ç…®é±¼ |
| ... | ... | ... | ... | ... |

### 3. æµ‹è¯•ä¸Šä¼ æµç¨‹
1. æ³¨å†Œè´¦å·
2. é…ç½®èœå“æ•°é‡
3. ä¸Šä¼ Excelæ–‡ä»¶
4. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼ˆåº”è¯¥æ˜¾ç¤ºè§£æè¿›åº¦ï¼‰

---

## âœ… ä¿®å¤ç¡®è®¤

**é—®é¢˜**ï¼šè·¯ç”±å†²çªå¯¼è‡´åç«¯æ— æ³•å¯åŠ¨  
**çŠ¶æ€**ï¼šâœ… **å·²è§£å†³**

**éªŒè¯æ–¹æ³•**ï¼š
```bash
curl http://localhost:8080/health
# åº”è¯¥è¿”å›ï¼š{"status":"ok",...}
```

---

**ä¿®å¤æ—¶é—´**ï¼šçº¦10åˆ†é’Ÿ  
**å½±å“èŒƒå›´**ï¼šä»…åç«¯è·¯ç”±æ³¨å†Œ  
**æ•°æ®å½±å“**ï¼šæ—   
**ç ´åæ€§æ›´æ”¹**ï¼šæ— 

